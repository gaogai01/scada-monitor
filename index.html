<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´é›²ç«¯ç›£æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 10px; }
        
        /* æ¨™é¡Œå€ */
        header { background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-left: 5px solid #007bff; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.2rem; letter-spacing: 1px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .btn-chart { background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-size: 0.85rem; }
        .status-box { font-size: 0.8rem; color: #555; background: #e9ecef; padding: 4px 10px; border-radius: 15px; font-weight: bold; }
        
        /* åˆ†å€æ¨™é¡Œ */
        .system-group { margin-bottom: 20px; }
        .system-title { font-size: 1.1rem; color: #343a40; margin-bottom: 8px; padding-left: 10px; border-left: 4px solid #28a745; font-weight: bold; display: flex; align-items: center; }
        .system-title span { background: #d4edda; color: #155724; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: normal; }

        /* å¡ç‰‡ç¶²æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        
        /* æ•¸æ“šå¡ç‰‡ */
        .card { background: white; border-radius: 6px; padding: 8px 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s ease; border-top: 3px solid #ccc; position: relative; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        
        /* --- ç³»çµ±é¡è‰² (æ›´æ–°) --- */
        .group-d01 .card  { border-top-color: #007bff; } /* D01: è—è‰² */
        .group-wm01 .card { border-top-color: #17a2b8; } /* WM01: é’è‰² (æ–°) */
        .group-wm02 .card { border-top-color: #6f42c1; } /* WM02: ç´«è‰² */
        .group-wm05 .card { border-top-color: #fd7e14; } /* WM05: æ©˜è‰² */

        /* è­¦å ±é¡è‰² */
        .card.status-warning { background-color: #fff3cd; border-top-color: #ffc107 !important; animation: pulse-orange 2s infinite; }
        .card.status-warning .value, .card.status-warning .tag-name { color: #856404; }
        .card.status-critical { background-color: #f8d7da; border-top-color: #dc3545 !important; animation: pulse-red 1.5s infinite; }
        .card.status-critical .value, .card.status-critical .tag-name { color: #721c24; font-weight: 900; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 5px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        /* å¡ç‰‡å…§å®¹ */
        .card-header { margin-bottom: 2px; border-bottom: 1px solid rgba(0,0,0,0.03); padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        .tag-name { font-size: 0.9rem; color: #444; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tag-id { font-size: 0.7rem; color: #aaa; font-family: Consolas, monospace; } 
        .data-row { display: flex; align-items: baseline; justify-content: center; margin-top: 5px; }
        .value { font-size: 1.6rem; font-weight: bold; color: #2c3e50; font-family: 'Arial', sans-serif; line-height: 1; }
        .unit { font-size: 0.75rem; color: #888; margin-left: 4px; }
        
        .loading { text-align: center; padding: 20px; color: #aaa; font-size: 1rem; }

        /* æ‰‹æ©Ÿç‰ˆé›™æ¬„ */
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            h1 { font-size: 1.1rem; }
            .value { font-size: 1.4rem; }
            .container { padding: 0 5px; }
            .modal-content { margin: 10% auto; width: 95%; padding: 15px; }
            .chart-controls { flex-direction: column; }
        }

        /* Modal æ¨£å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { font-size: 1.5rem; cursor: pointer; }
        .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .control-group { display: flex; flex-direction: column; min-width: 120px; flex: 1; }
        .control-group label { font-size: 0.8rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        select { padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 0.9rem; }
        .checkbox-list { max-height: 100px; overflow-y: auto; border: 1px solid #ddd; background: white; padding: 5px; border-radius: 4px; }
        .checkbox-item { display: flex; align-items: center; font-size: 0.85rem; margin-bottom: 4px; }
        .checkbox-item input { margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´ç›£æ§</h1>
        <div class="header-right">
            <button class="btn-chart" onclick="openChartModal()">ğŸ“Š æ­·å²æ›²ç·š</button>
            <div class="status-box">æ›´æ–°: <span id="last-update">é€£ç·šä¸­...</span></div>
        </div>
    </header>

    <div id="app">
        <div class="loading">æ­£åœ¨åŒæ­¥æ•¸æ“š...</div>
    </div>
</div>

<div id="chartModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>æ­·å²è¶¨å‹¢åˆ†æ</h2>
            <span class="close-btn" onclick="closeChartModal()">&times;</span>
        </div>
        <div class="chart-controls">
            <div class="control-group">
                <label>1. æ™‚é–“ç¯„åœ</label>
                <select id="timeRange" onchange="updateChart()">
                    <option value="24">éå» 24 å°æ™‚</option>
                    <option value="168">éå» 7 å¤©</option>
                    <option value="720">éå» 30 å¤©</option>
                </select>
            </div>
            <div class="control-group">
                <label>2. æ•¸æ“šé¡åˆ¥</label>
                <select id="categorySelect" onchange="renderCheckboxes()">
                    <option value="level">æ¶²ä½ (cm)</option>
                    <option value="flow">æµé‡ (M3/Hr)</option>
                    <option value="quality">æ°´è³ªç›£æ¸¬ (PH, COD...)</option>
                </select>
            </div>
            <div class="control-group" style="flex: 2;">
                <label>3. é¸æ“‡é»ä½ (å¯è¤‡é¸)</label>
                <div id="tagCheckboxes" class="checkbox-list"></div>
            </div>
        </div>
        <div style="position: relative; height:300px; width:100%">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // 1. Google Apps Script ç¶²å€
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzwFRkiITDbICO-zisn_rr-6uT0-DFNeMvgFFYWFTVKHGrZz7K9XbIi18NBW4Gr2Nty/exec"; 
    // â†‘â†‘â†‘ è«‹ç¢ºèªé€™æ˜¯æ‚¨æœ€æ–°çš„ç¶²å€ â†‘â†‘â†‘

    // ============================================================
    // 2. è­¦å ±è¦å‰‡
    // ============================================================
    const ALARMS = {
        "LI018_VAL0":   { warn: 90,  crit: 100 }, // LI01-07 æ”¾æµæ°´æ¶²ä½
        "SS018_VAL0":   { warn: 20,  crit: 30  }, // SS01-07 æ‡¸æµ®å›ºé«”
        "COD018_VAL0":  { warn: 80,  crit: 100 }, // COD01-07 åŒ–å­¸éœ€æ°§é‡
        "OFD018_VAL0":  { warn: 6,   crit: 10  }, // OFD01-07 æ²¹ä»½æ¿ƒåº¦
        "NH3N018_VAL0": { warn: 30,  crit: 60  }, // NH3N01-07 æ°¨æ°®æ¿ƒåº¦
        "LI021_VAL0":   { warn: 410, crit: 430 }, // LI02-01 æ±¡æ°´æ”¶é›†æ§½æ¶²ä½
        "LI012_VAL0":   { warn: 210, crit: 230 }, // LI01-01 å»¢æ°´å„²æ§½æ¶²ä½
        "LIT000_VAL0":  { warn: 90,  crit: 120 }, // LI05-01 å»¢æ²¹æ°´ç·©è¡æ¶²ä½
    };

    // ============================================================
    // 3. å„€è¡¨æ¿å…§å®¹ (ä¾ç…§æ–°éœ€æ±‚èª¿æ•´)
    // ============================================================
    const DASHBOARD_CONFIG = [
        {
            id: "d01",
            title: "D01 æ”¾æµæ°´æ°´è³ª",
            className: "group-d01",
            items: [
                // åŸéæ¿¾ç³»çµ±ç§»é™¤äº†æ¶²ä½å’Œæµé‡ï¼Œå‰©ä¸‹æ°´è³ª
                { col: "SS018_VAL0",   tag: "SS01-07",   name: "æ‡¸æµ®å›ºé«”",       unit: "mg/L", cat: "quality" },
                { col: "COD018_VAL0",  tag: "COD01-07",  name: "åŒ–å­¸éœ€æ°§é‡",     unit: "mg/L", cat: "quality" },
                { col: "OFD018_VAL0",  tag: "OFD01-07",  name: "æ²¹ä»½æ¿ƒåº¦",       unit: "mg/L", cat: "quality" },
                { col: "NH3N018_VAL0", tag: "NH3N01-07", name: "æ°¨æ°®æ¿ƒåº¦",       unit: "mg/L", cat: "quality" },
                { col: "PHI018_VAL0",  tag: "PH01-07",   name: "é…¸é¹¼å€¼",         unit: "",     cat: "quality" }
            ]
        },
        {
            id: "wm01",
            title: "WM01 äº‹æ¥­å»¢æ°´è™•ç†",
            className: "group-wm01",
            items: [
                // å»¢æ°´å„²æ§½ç§»ä¾†ç¬¬ä¸€å€‹
                { col: "LI012_VAL0",   tag: "LI01-01",   name: "å»¢æ°´å„²æ§½æ¶²ä½",   unit: "cm",   cat: "level" },
                // æ”¾æµæ°´æ¶²ä½å’Œæµé‡ç§»ä¾†é€™è£¡
                { col: "LI018_VAL0",   tag: "LI01-07",   name: "æ”¾æµæ°´æ¶²ä½",     unit: "cm",   cat: "level" },
                { col: "FI018_VAL0",   tag: "FIT01-07",  name: "æ”¾æµæµé‡",       unit: "M3/Hr",cat: "flow" }
            ]
        },
        {
            id: "wm02",
            title: "WM02 ç”Ÿæ´»æ±¡æ°´è™•ç†",
            className: "group-wm02",
            items: [
                // åŸ SBR ç³»çµ±
                { col: "LI021_VAL0",   tag: "LI02-01",   name: "æ±¡æ°´æ”¶é›†æ§½",     unit: "cm",   cat: "level" },
                { col: "FI021W_VAL0",  tag: "FIT02-01",  name: "é€²æµæµé‡",       unit: "M3/Hr",cat: "flow" },
                { col: "LI022_VAL0",   tag: "LI02-02",   name: "è™•ç†è¨­å‚™æ¶²ä½",   unit: "cm",   cat: "level" },
                { col: "LI011_VAL0",   tag: "T02-04",    name: "å›æ”¶æ°´æ§½æ¶²ä½",   unit: "cm",   cat: "level" }
            ]
        },
        {
            id: "wm05",
            title: "WM05 å«æ²¹äº‹æ¥­å»¢æ°´è™•ç†",
            className: "group-wm05",
            items: [
                // åŸ å»¢æ²¹æ°´ & DAF ç³»çµ± (ç§»é™¤æ²¹è†œæª¢çŸ¥)
                { col: "LIT000_VAL0",  tag: "LI05-01",   name: "å»¢æ²¹æ°´ç·©è¡",     unit: "cm",   cat: "level" },
                { col: "FIT000A_VAL0", tag: "FIT05-01A", name: "é€²æµ A",         unit: "M3/Hr",cat: "flow" },
                { col: "FIT000B_VAL0", tag: "FIT05-01B", name: "é€²æµ B",         unit: "M3/Hr",cat: "flow" },
                { col: "FI003_VAL0",   tag: "FIT05-04",  name: "å‡ºå£æµé‡",       unit: "M3/Hr",cat: "flow" },
                { col: "LI003_VAL0",   tag: "LI05-04",   name: "ä¸­é–“æ°´æ§½",       unit: "cm",   cat: "level" }
            ]
        }
    ];

    function checkAlarm(colName, value) {
        let val = parseFloat(value);
        if (isNaN(val)) return "";
        if (colName === "PHI018_VAL0") {
            if (val < 6 || val > 9) return "status-critical";
            if (val < 6.5 || val > 8.5) return "status-warning";
            return "";
        }
        const rule = ALARMS[colName];
        if (rule) {
            if (val >= rule.crit) return "status-critical";
            if (val >= rule.warn) return "status-warning";
        }
        return "";
    }

    function fetchData() {
        fetch(API_URL + "?mode=read&t=" + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if(data.timestamp) {
                    let timeOnly = data.timestamp.split(' ')[1] || data.timestamp;
                    document.getElementById('last-update').innerText = timeOnly;
                }

                let htmlContent = '';

                DASHBOARD_CONFIG.forEach(group => {
                    htmlContent += `
                        <div class="system-group ${group.className}">
                            <div class="system-title">${group.title} <span>${group.items.length}</span></div>
                            <div class="grid">
                    `;

                    group.items.forEach(item => {
                        let val = data[item.col] !== undefined ? data[item.col] : '--';
                        if (!isNaN(val) && val.toString().indexOf('.') !== -1) {
                             val = parseFloat(val).toFixed(1);
                             if(val.endsWith('.0')) val = val.replace('.0', '');
                        }
                        let statusClass = checkAlarm(item.col, val);
                        htmlContent += `
                            <div class="card ${statusClass}">
                                <div class="card-header"><span class="tag-name">${item.name}</span><span class="tag-id">${item.tag}</span></div>
                                <div class="data-row"><span class="value">${val}</span><span class="unit">${item.unit}</span></div>
                            </div>`;
                    });
                    htmlContent += `</div></div>`;
                });
                document.getElementById('app').innerHTML = htmlContent;
            })
            .catch(err => console.error(err));
    }

    setInterval(fetchData, 5000);
    fetchData();

    // --- åœ–è¡¨é‚è¼¯ ---
    let historyData = null;
    let myChart = null;

    function openChartModal() {
        document.getElementById('chartModal').style.display = 'block';
        renderCheckboxes();
        if (!historyData) fetchHistory();
    }

    function closeChartModal() {
        document.getElementById('chartModal').style.display = 'none';
    }

    function fetchHistory() {
        fetch(API_URL + "?mode=history")
            .then(res => res.json())
            .then(json => {
                historyData = json;
                updateChart();
            });
    }

    function renderCheckboxes() {
        const cat = document.getElementById('categorySelect').value;
        const container = document.getElementById('tagCheckboxes');
        container.innerHTML = '';
        let items = [];
        DASHBOARD_CONFIG.forEach(group => {
            group.items.forEach(item => {
                if (item.cat === cat) items.push(item);
            });
        });
        items.forEach((item, index) => {
            const checked = index === 0 ? 'checked' : '';
            container.innerHTML += `
                <div class="checkbox-item">
                    <input type="checkbox" value="${item.col}" id="chk_${item.col}" ${checked} onchange="updateChart()">
                    <label for="chk_${item.col}">${item.name} (${item.tag})</label>
                </div>
            `;
        });
        updateChart();
    }

    function updateChart() {
        if (!historyData) return;
        const timeRangeHours = parseInt(document.getElementById('timeRange').value);
        const headers = historyData.headers;
        const rawRows = historyData.data;
        const checkboxes = document.querySelectorAll('#tagCheckboxes input:checked');
        const selectedCols = [];
        checkboxes.forEach(chk => {
            const idx = headers.indexOf(chk.value);
            if (idx !== -1) {
                selectedCols.push({ idx: idx, label: chk.nextElementSibling.innerText, data: [] });
            }
        });

        const now = new Date();
        const labels = [];
        rawRows.forEach(row => {
            let timeStr = row[0];
            let rowDate = new Date(timeStr);
            let diffHours = (now - rowDate) / 1000 / 60 / 60;
            if (diffHours <= timeRangeHours) {
                let label = rowDate.getMonth()+1 + "/" + rowDate.getDate() + " " + rowDate.getHours() + ":" + (rowDate.getMinutes()<10?'0':'') + rowDate.getMinutes();
                labels.push(label);
                selectedCols.forEach(col => { col.data.push(row[col.idx]); });
            }
        });

        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();
        const colors = ['#007bff', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#17a2b8'];

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: selectedCols.map((col, i) => ({
                    label: col.label,
                    data: col.data,
                    borderColor: colors[i % colors.length],
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: false,
                    tension: 0.1
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { ticks: { maxTicksLimit: 10 } } }
            }
        });
    }
</script>

</body>
</html>
