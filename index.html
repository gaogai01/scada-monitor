<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´é›²ç«¯ç›£æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS è®Šæ•¸ --- */
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #666666;
            --border-color: #e0e0e0;
            
            /* Google é¢¨æ ¼é¡è‰² */
            --color-good: #0cce6b;   /* ç¶  */
            --color-warn: #ffa400;   /* æ©˜ */
            --color-poor: #ff4e42;   /* ç´… */
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #aaaaaa;
            --border-color: #333333;
        }

        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 5px; transition: background 0.3s; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 5px; }
        
        header { background: var(--bg-card); padding: 5px 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-left: 5px solid #007bff; }
        h1 { color: var(--text-main); margin: 0; font-size: 1.1rem; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        button.btn-ctrl { background: #007bff; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .status-box { font-size: 0.75rem; color: var(--text-sub); background: var(--border-color); padding: 3px 8px; border-radius: 10px; font-weight: bold; }

        /* --- ç³»çµ±å€å¡Š --- */
        #app { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px; align-items: start; }
        .system-group { background: var(--bg-card); border-radius: 6px; padding: 8px; border: 1px solid var(--border-color); }
        .system-title { font-size: 0.95rem; margin-bottom: 6px; padding-left: 8px; border-left: 4px solid #28a745; font-weight: bold; display: flex; justify-content: space-between; }
        .system-title span { background: var(--border-color); color: var(--text-sub); font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; font-weight: normal; }

        .inner-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 6px; }
        
        /* --- å¡ç‰‡æ¨£å¼ --- */
        .card { background: var(--bg-body); border-radius: 4px; padding: 8px; border: 1px solid var(--border-color); border-top: 3px solid #ccc; position: relative; }
        .group-d01 .card  { border-top-color: #007bff; }
        .group-wm01 .card { border-top-color: #17a2b8; }
        .group-wm02 .card { border-top-color: #6f42c1; }
        .group-wm05 .card { border-top-color: #fd7e14; }
        .group-d02 .card  { border-top-color: #20c997; }
        .group-cds .card  { border-top-color: #e83e8c; }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .tag-name { font-size: 0.85rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
        .tag-id { font-size: 0.65rem; color: var(--text-sub); opacity: 0.7; }
        
        .data-row { display: flex; align-items: baseline; justify-content: flex-end; margin-bottom: 5px; }
        .value { font-size: 1.5rem; font-weight: bold; line-height: 1; }
        .unit { font-size: 0.7rem; color: var(--text-sub); margin-left: 4px; }

        /* --- å„€è¡¨æ¿ (Gauge) æ¨£å¼ - æ ¸å¿ƒä¿®æ”¹ --- */
        .gauge-container {
            height: 6px;
            width: 100%;
            background: #eee;
            border-radius: 3px;
            position: relative;
            display: flex;
            margin-top: 5px;
            overflow: visible; /* è®“æŒ‡é‡å¯ä»¥å‡¸å‡ºå» */
        }
        
        /* ä¸‰è‰²å€æ®µ */
        .gauge-seg { height: 100%; }
        .seg-good { background-color: var(--color-good); border-radius: 3px 0 0 3px; }
        .seg-warn { background-color: var(--color-warn); }
        .seg-poor { background-color: var(--color-poor); border-radius: 0 3px 3px 0; }
        
        /* æ•¸å€¼æŒ‡é‡ */
        .gauge-marker {
            position: absolute;
            top: -3px; /* å¾€ä¸Šå‡¸ä¸€é» */
            width: 2px;
            height: 12px;
            background-color: #333;
            border: 1px solid #fff;
            transform: translateX(-50%);
            z-index: 2;
            transition: left 0.5s ease;
        }
        
        /* æ•¸å€¼é¡è‰²è®ŠåŒ– (ç•¶æ•¸å€¼è½å…¥è©²å€é–“æ™‚) */
        .val-good { color: var(--color-good); }
        .val-warn { color: var(--color-warn); }
        .val-poor { color: var(--color-poor); }

        /* æ‰‹æ©Ÿç‰ˆè¨­å®š */
        @media (max-width: 600px) {
            #app { grid-template-columns: 1fr; } 
            .inner-grid { grid-template-columns: 1fr 1fr; }
            h1 { font-size: 1rem; }
            .modal-content { margin: 20% auto; width: 95%; padding: 15px; }
            .chart-controls { flex-direction: column; }
        }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--bg-card); color: var(--text-main); margin: 3% auto; padding: 15px; border-radius: 8px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }
        .chart-controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; background: var(--bg-body); padding: 8px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´ç›£æ§</h1>
        <div class="header-right">
            <button class="btn-ctrl" onclick="toggleTheme()" id="themeBtn">ğŸŒ“</button>
            <button class="btn-ctrl" onclick="openChartModal()">ğŸ“Š è¶¨å‹¢</button>
            <div class="status-box">æ›´æ–°: <span id="last-update">...</span></div>
        </div>
    </header>

    <div id="app">
        <div class="loading">æ­£åœ¨åŒæ­¥æ•¸æ“š...</div>
    </div>
</div>

<div id="chartModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>æ­·å²è¶¨å‹¢</h3><span class="close-btn" onclick="closeChartModal()">&times;</span></div>
        <div class="chart-controls">
            <select id="timeRange" onchange="updateChart()"><option value="24">24H</option><option value="168">7D</option></select>
            <select id="categorySelect" onchange="renderCheckboxes()"><option value="level">æ¶²ä½</option><option value="flow">æµé‡</option><option value="quality">æ°´è³ª</option><option value="temp">æº«åº¦</option></select>
            <div id="tagCheckboxes" style="flex:1; max-height:60px; overflow-y:auto;"></div>
        </div>
        <canvas id="myChart" style="height:300px; width:100%"></canvas>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzwFRkiITDbICO-zisn_rr-6uT0-DFNeMvgFFYWFTVKHGrZz7K9XbIi18NBW4Gr2Nty/exec"; 
    // â†‘â†‘â†‘ è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„ç¶²å€ â†‘â†‘â†‘

    // ============================================================
    // è­¦å ±è¦å‰‡ (æ–°å¢ max ç”¨æ–¼ç¹ªè£½å„€è¡¨æ¿)
    // max: è©²æ•¸å€¼çš„æœ€å¤§åˆ»åº¦ (é€šå¸¸æ˜¯æ»¿æ°´ä½æˆ–å„€è¡¨ä¸Šé™)
    // warn: è¶…éè®Šæ©˜è‰²
    // crit: è¶…éè®Šç´…è‰²
    // ============================================================
    const ALARMS = {
        "LI018_VAL0":   { max: 120, warn: 90,  crit: 100 }, // æ”¾æµæ¶²ä½
        "SS018_VAL0":   { max: 50,  warn: 20,  crit: 30  }, // SS
        "COD018_VAL0":  { max: 150, warn: 80,  crit: 100 }, // COD
        "OFD018_VAL0":  { max: 20,  warn: 6,   crit: 10  }, // æ²¹åˆ†
        "NH3N018_VAL0": { max: 80,  warn: 30,  crit: 60  }, // æ°¨æ°®
        "LI021_VAL0":   { max: 500, warn: 410, crit: 430 }, // æ±¡æ°´æ”¶é›†æ§½
        "LI012_VAL0":   { max: 300, warn: 210, crit: 230 }, // å»¢æ°´å„²æ§½
        "LIT000_VAL0":  { max: 150, warn: 90,  crit: 120 }, // å»¢æ²¹æ°´ç·©è¡
        "D02_TEMP":     { max: 50,  warn: 35,  crit: 38  }, // D02 æ°´æº«
        // PHå€¼ 0-14 å›ºå®š
    };

    const DASHBOARD_CONFIG = [
        {
            id: "d01", title: "D01 æ”¾æµæ°´æ°´è³ª", className: "group-d01",
            items: [
                { col: "SS018_VAL0",   tag: "SS01-07",   name: "æ‡¸æµ®å›ºé«”",       unit: "mg/L", cat: "quality" },
                { col: "COD018_VAL0",  tag: "COD01-07",  name: "åŒ–å­¸éœ€æ°§é‡",     unit: "mg/L", cat: "quality" },
                { col: "OFD018_VAL0",  tag: "OFD01-07",  name: "æ²¹ä»½æ¿ƒåº¦",       unit: "mg/L", cat: "quality" },
                { col: "NH3N018_VAL0", tag: "NH3N01-07", name: "æ°¨æ°®æ¿ƒåº¦",       unit: "mg/L", cat: "quality" },
                { col: "PHI018_VAL0",  tag: "PH01-07",   name: "é…¸é¹¼å€¼",         unit: "",     cat: "quality" }
            ]
        },
        {
            id: "d02", title: "D02 æœªæ¥è§¸å†·å»æ°´", className: "group-d02",
            items: [
                { col: "D02_TEMP",     tag: "D02-Temp",  name: "æ”¾æµæ°´æº«",       unit: "Â°C",   cat: "temp" },
                { col: "D02_FLOW",     tag: "D02-Flow",  name: "æ”¾æµæ°´é‡",       unit: "M3",   cat: "flow" }
            ]
        },
        {
            id: "wm01", title: "WM01 äº‹æ¥­å»¢æ°´", className: "group-wm01",
            items: [
                { col: "LI012_VAL0",   tag: "LI01-01",   name: "å»¢æ°´å„²æ§½æ¶²ä½",   unit: "cm",   cat: "level" },
                { col: "PHI013_VAL0",  tag: "PH01-03",   name: "ç¬¬ä¸€é…¸é¹¼æ§½PH",   unit: "",     cat: "quality" },
                { col: "PHI014_VAL0",  tag: "PH01-04",   name: "è† å‡æ§½PH",       unit: "",     cat: "quality" },
                { col: "PHI017_VAL0",  tag: "PH01-06",   name: "ç¬¬äºŒé…¸é¹¼æ§½PH",   unit: "",     cat: "quality" },
                { col: "LI018_VAL0",   tag: "LI01-07",   name: "æ”¾æµæ°´æ¶²ä½",     unit: "cm",   cat: "level" },
                { col: "FI018_VAL0",   tag: "FIT01-07",  name: "æ”¾æµæµé‡",       unit: "M3/Hr",cat: "flow" }
            ]
        },
        {
            id: "wm02", title: "WM02 ç”Ÿæ´»æ±¡æ°´", className: "group-wm02",
            items: [
                { col: "LI021_VAL0",   tag: "LI02-01",   name: "ç”Ÿæ´»æ±¡æ°´å„²æ§½",   unit: "cm",   cat: "level" },
                { col: "FI021W_VAL0",  tag: "FIT02-01",  name: "å‡ºå£æµé‡",       unit: "M3/Hr",cat: "flow" },
                { col: "LI022_VAL0",   tag: "LI02-02",   name: "SBRæ¶²ä½",        unit: "cm",   cat: "level" },
                { col: "LI011_VAL0",   tag: "T02-04",    name: "å›æ”¶æ°´æ§½æ¶²ä½",   unit: "cm",   cat: "level" }
            ]
        },
        {
            id: "wm05", title: "WM05 å«æ²¹äº‹æ¥­å»¢æ°´", className: "group-wm05",
            items: [
                { col: "FIT000B_VAL0", tag: "FIT05-01B", name: "APIé€²å£æµé‡",    unit: "M3/Hr",cat: "flow" },
                { col: "LIT000_VAL0",  tag: "LI05-01",   name: "äºŒæ®µå¼APIæ¶²ä½",  unit: "cm",   cat: "level" },
                { col: "FIT000A_VAL0", tag: "FIT05-01A", name: "APIå‡ºå£æµé‡",    unit: "M3/Hr",cat: "flow" },
                { col: "LI003_VAL0",   tag: "LI05-04",   name: "ä¸­é–“æ°´æ§½æ¶²ä½",   unit: "cm",   cat: "level" },
                { col: "FI003_VAL0",   tag: "FIT05-04",  name: "DAFé€²å£æµé‡",    unit: "M3/Hr",cat: "flow" },
                { col: "PHI015_VAL0",  tag: "PH05-05",   name: "éœæ…‹æ”ªæ‹Œç®¡PH",   unit: "",     cat: "quality" }
            ]
        },
        {
            id: "cds", title: "CDS åŠ è—¥ç³»çµ±", className: "group-cds",
            items: [
                { col: "LI044_VAL0",   tag: "LI044",     name: "é¹¼æ§½æ¶²ä½",       unit: "cm",   cat: "level" },
                { col: "LI048_VAL0",   tag: "LI048",     name: "å‡è† å„²æ§½æ¶²ä½",   unit: "cm",   cat: "level" },
                { col: "LI049_VAL0",   tag: "LI049",     name: "PACå„²æ§½æ¶²ä½",    unit: "cm",   cat: "level" }
            ]
        }
    ];

    // --- ç”¢ç”Ÿå„€è¡¨æ¿ HTML (å« Gauge) ---
    function getGaugeHTML(colName, value) {
        let val = parseFloat(value);
        if (isNaN(val)) return "";

        let rule = ALARMS[colName];
        
        // è™•ç† PH å€¼ (é›™å‘ 0-14)
        if (colName.indexOf("PHI") !== -1) {
            let pct = (val / 14) * 100;
            // ç°¡åŒ–é¡¯ç¤ºï¼šä¸ç•«ä¸‰è‰²æ¢ï¼Œåªç•«é€²åº¦æ¢ï¼Œä½†ä¾æ“šæ•¸å€¼è®Šè‰²
            let colorVar = "var(--color-good)";
            if (val < 6 || val > 9) colorVar = "var(--color-poor)";
            else if (val < 6.5 || val > 8.5) colorVar = "var(--color-warn)";
            
            return `
            <div class="gauge-container">
                <div style="width: ${pct}%; background-color: ${colorVar}; height:100%; border-radius:3px;"></div>
                <div class="gauge-marker" style="left: ${pct}%"></div>
            </div>`;
        }

        // è™•ç†ä¸€èˆ¬æ•¸å€¼ (æœ‰è¨­å®š Max çš„æ‰ç•«ä¸‰è‰²æ¢)
        if (rule && rule.max) {
            let max = rule.max;
            // è¨ˆç®—å„å€æ®µç™¾åˆ†æ¯”
            let warnPct = (rule.warn / max) * 100;
            let critPct = (rule.crit / max) * 100;
            let valPct = Math.min((val / max) * 100, 100); // æŒ‡é‡ä¸è¶…é 100%

            // æ±ºå®šæ•¸å€¼é¡è‰²
            let valClass = "val-good";
            if (val >= rule.crit) valClass = "val-poor";
            else if (val >= rule.warn) valClass = "val-warn";

            return `
            <div class="gauge-container">
                <div class="gauge-seg seg-good" style="width: ${warnPct}%"></div>
                <div class="gauge-seg seg-warn" style="width: ${critPct - warnPct}%"></div>
                <div class="gauge-seg seg-poor" style="width: ${100 - critPct}%"></div>
                <div class="gauge-marker" style="left: ${valPct}%"></div>
            </div>
            <script>document.currentScript.parentElement.parentElement.querySelector('.value').className = "value ${valClass}";<\/script>
            `;
        }
        
        // æ²’æœ‰è¨­å®š Max çš„ä¸ç•«æ¢ï¼Œåªå›å‚³ç©ºå­—ä¸²
        return ""; 
    }

    function fetchData() {
        fetch(API_URL + "?mode=read&t=" + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if(data.timestamp) {
                    let timeOnly = data.timestamp.split(' ')[1] || data.timestamp;
                    document.getElementById('last-update').innerText = timeOnly;
                }

                let htmlContent = '';

                DASHBOARD_CONFIG.forEach(group => {
                    htmlContent += `
                        <div class="system-group ${group.className}">
                            <div class="system-title">${group.title} <span>${group.items.length}</span></div>
                            <div class="inner-grid">
                    `;

                    group.items.forEach(item => {
                        let val = data[item.col] !== undefined ? data[item.col] : '--';
                        if (!isNaN(val) && val.toString().indexOf('.') !== -1) {
                             val = parseFloat(val).toFixed(1);
                             if(val.endsWith('.0')) val = val.replace('.0', '');
                        }
                        
                        // ç”¢ç”Ÿ Gauge æ¢
                        let gaugeHTML = getGaugeHTML(item.col, val);
                        
                        // åˆ¤æ–·æ–‡å­—é¡è‰² (é€é getGaugeHTML å…§éƒ¨çš„é‚è¼¯æˆ– CSS)
                        // è‹¥ç„¡ Gaugeï¼Œå‰‡å›æ­¸é è¨­é»‘è‰²
                        
                        htmlContent += `
                            <div class="card">
                                <div class="card-header"><span class="tag-name">${item.name}</span><span class="tag-id">${item.tag}</span></div>
                                <div class="data-row"><span class="value">${val}</span><span class="unit">${item.unit}</span></div>
                                ${gaugeHTML}
                            </div>`;
                    });
                    htmlContent += `</div></div>`;
                });
                document.getElementById('app').innerHTML = htmlContent;
            })
            .catch(err => console.error(err));
    }

    setInterval(fetchData, 5000);
    fetchData();

    // --- (ä»¥ä¸‹ç‚ºåˆ‡æ›ä¸»é¡Œèˆ‡åœ–è¡¨ä»£ç¢¼ï¼Œèˆ‡å‰ç‰ˆç›¸åŒï¼Œçœç•¥ä»¥ç¯€çœç©ºé–“) ---
    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        document.getElementById("themeBtn").innerHTML = newTheme === "dark" ? "â˜€ï¸" : "ğŸŒ“";
        if(myChart) updateChart(); 
    }
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
        document.body.setAttribute("data-theme", savedTheme);
        document.getElementById("themeBtn").innerHTML = savedTheme === "dark" ? "â˜€ï¸" : "ğŸŒ“";
    }
    
    // ... (Modal èˆ‡ Chart é‚è¼¯è«‹ç›´æ¥ä½¿ç”¨ä¸Šä¸€å€‹ç‰ˆæœ¬ï¼Œé€™è£¡ç‚ºäº†å®Œæ•´æ€§ï¼Œå»ºè­°ç›´æ¥ä¿ç•™åŸæœ‰çš„ script å€å¡Šä¸‹åŠéƒ¨) ...
    let historyData = null;
    let myChart = null;
    function openChartModal() { document.getElementById('chartModal').style.display = 'block'; renderCheckboxes(); if (!historyData) fetchHistory(); }
    function closeChartModal() { document.getElementById('chartModal').style.display = 'none'; }
    function fetchHistory() { fetch(API_URL + "?mode=history").then(res => res.json()).then(json => { historyData = json; updateChart(); }); }
    function renderCheckboxes() {
        const cat = document.getElementById('categorySelect').value;
        const container = document.getElementById('tagCheckboxes');
        container.innerHTML = '';
        let items = [];
        DASHBOARD_CONFIG.forEach(group => { group.items.forEach(item => { if (item.cat === cat) items.push(item); }); });
        items.forEach((item, index) => {
            const checked = index === 0 ? 'checked' : '';
            container.innerHTML += `<label style="display:inline-block; margin-right:10px;"><input type="checkbox" value="${item.col}" id="chk_${item.col}" ${checked} onchange="updateChart()"> ${item.name}</label>`;
        });
        updateChart();
    }
    function updateChart() {
        if (!historyData) return;
        const timeRangeHours = parseInt(document.getElementById('timeRange').value);
        const headers = historyData.headers;
        const rawRows = historyData.data;
        const checkboxes = document.querySelectorAll('#tagCheckboxes input:checked');
        const selectedCols = [];
        checkboxes.forEach(chk => {
            const idx = headers.indexOf(chk.value);
            if (idx !== -1) { selectedCols.push({ idx: idx, label: chk.parentNode.textContent.trim(), data: [] }); }
        });
        const now = new Date();
        const labels = [];
        rawRows.forEach(row => {
            let timeStr = row[0];
            let rowDate = new Date(timeStr);
            let diffHours = (now - rowDate) / 1000 / 60 / 60;
            if (diffHours <= timeRangeHours) {
                let label = rowDate.getMonth()+1 + "/" + rowDate.getDate() + " " + rowDate.getHours() + ":" + (rowDate.getMinutes()<10?'0':'') + rowDate.getMinutes();
                labels.push(label);
                selectedCols.forEach(col => { col.data.push(row[col.idx]); });
            }
        });
        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();
        const isDark = document.body.getAttribute("data-theme") === "dark";
        const gridColor = isDark ? '#444' : '#ddd';
        const textColor = isDark ? '#eee' : '#666';
        const colors = ['#007bff', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#17a2b8'];
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: selectedCols.map((col, i) => ({ label: col.label, data: col.data, borderColor: colors[i % colors.length], borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 })) },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxTicksLimit: 10 } } } }
        });
    }
</script>

</body>
</html>
