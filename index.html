<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>尖山發電廠 - 廢油水雲端監控</title>
    <style>
        /* --- 全域設定：緊湊模式 --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 10px; }
        
        /* 標題區：縮小高度 */
        header { background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-left: 5px solid #007bff; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.2rem; letter-spacing: 1px; }
        .status-box { font-size: 0.8rem; color: #555; background: #e9ecef; padding: 4px 10px; border-radius: 15px; font-weight: bold; }
        
        /* 分區標題：縮小間距 */
        .system-group { margin-bottom: 15px; }
        .system-title { font-size: 1.1rem; color: #343a40; margin-bottom: 8px; padding-left: 10px; border-left: 4px solid #28a745; font-weight: bold; display: flex; align-items: center; }
        .system-title span { background: #d4edda; color: #155724; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: normal; }

        /* --- 卡片網格系統 (核心修改) --- */
        .grid { 
            display: grid; 
            /* 電腦版預設：自動填滿，最小寬度縮到 140px，這樣一排可以塞很多張 */
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 8px; /* 縮小卡片間距 */
        }
        
        /* 數據卡片：緊湊化 */
        .card { 
            background: white; 
            border-radius: 6px; 
            padding: 8px 10px; /* 減少內距 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            transition: all 0.2s ease; 
            border-top: 3px solid #ccc; 
            position: relative; 
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        
        /* 系統顏色 */
        .group-filter .card { border-top-color: #007bff; }
        .group-sbr .card { border-top-color: #6f42c1; }
        .group-daf .card { border-top-color: #fd7e14; }

        /* 警報顏色 - 閃爍動畫 */
        .card.status-warning { background-color: #fff3cd; border-top-color: #ffc107 !important; animation: pulse-orange 2s infinite; }
        .card.status-warning .value, .card.status-warning .tag-name { color: #856404; }

        .card.status-critical { background-color: #f8d7da; border-top-color: #dc3545 !important; animation: pulse-red 1.5s infinite; }
        .card.status-critical .value, .card.status-critical .tag-name { color: #721c24; font-weight: 900; }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 5px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        /* 卡片內容排版：字體縮小 */
        .card-header { margin-bottom: 2px; border-bottom: 1px solid rgba(0,0,0,0.03); padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        .tag-name { font-size: 0.9rem; color: #444; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* 把 tag-id 縮小並淡化，節省空間 */
        .tag-id { font-size: 0.7rem; color: #aaa; font-family: Consolas, monospace; } 
        
        .data-row { display: flex; align-items: baseline; justify-content: center; margin-top: 5px; }
        .value { font-size: 1.6rem; font-weight: bold; color: #2c3e50; font-family: 'Arial', sans-serif; line-height: 1; }
        .unit { font-size: 0.75rem; color: #888; margin-left: 4px; }
        
        .loading { text-align: center; padding: 20px; color: #aaa; font-size: 1rem; }

        /* --- 手機版專用設定 (關鍵修改) --- */
        @media (max-width: 600px) {
            .grid {
                /* 強制兩欄 */
                grid-template-columns: 1fr 1fr; 
                gap: 8px;
            }
            h1 { font-size: 1.1rem; }
            .value { font-size: 1.4rem; } /* 手機版數字再稍微小一點以防爆版 */
            .tag-name { font-size: 0.85rem; }
            .container { padding: 0 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>尖山發電廠 - 廢油水監控</h1>
        <div class="status-box">更新: <span id="last-update">連線中...</span></div>
    </header>

    <div id="app">
        <div class="loading">正在同步數據...</div>
    </div>
</div>

<script>
    // ============================================================
    // 1. Google Apps Script 網址
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzwFRkiITDbICO-zisn_rr-6uT0-DFNeMvgFFYWFTVKHGrZz7K9XbIi18NBW4Gr2Nty/exec"; 
    // ↑↑↑ 請確認這是你的 Google 網址 ↑↑↑

    // ============================================================
    // 2. 警報規則
    // ============================================================
    const ALARMS = {
        "LI018_VAL0":   { warn: 90,  crit: 100 },
        "SS018_VAL0":   { warn: 20,  crit: 30  },
        "COD018_VAL0":  { warn: 80,  crit: 100 },
        "OFD018_VAL0":  { warn: 6,   crit: 10  },
        "NH3N018_VAL0": { warn: 30,  crit: 60  },
        "LI021_VAL0":   { warn: 210, crit: 230 },
        // PH值 logic 在 checkAlarm 函數中
    };

    // ============================================================
    // 3. 儀表板內容
    // ============================================================
    const DASHBOARD_CONFIG = [
        {
            id: "filter",
            title: "過濾系統",
            className: "group-filter",
            items: [
                { col: "LI018_VAL0",   tag: "LI01-07",   name: "放流水液位",     unit: "cm" },
                { col: "SS018_VAL0",   tag: "SS01-07",   name: "懸浮固體",       unit: "mg/L" },
                { col: "COD018_VAL0",  tag: "COD01-07",  name: "化學需氧量",     unit: "mg/L" },
                { col: "OFD018_VAL0",  tag: "OFD01-07",  name: "油份濃度",       unit: "mg/L" },
                { col: "NH3N018_VAL0", tag: "NH3N01-07", name: "氨氮濃度",       unit: "mg/L" },
                { col: "PHI018_VAL0",  tag: "PH01-07",   name: "酸鹼值",         unit: "" },
                { col: "FI018_VAL0",   tag: "FIT01-07",  name: "放流流量",       unit: "M3/Hr" }
            ]
        },
        {
            id: "sbr",
            title: "SBR 系統",
            className: "group-sbr",
            items: [
                { col: "LI021_VAL0",   tag: "LI02-01",   name: "污水收集槽", unit: "cm" },
                { col: "FI021W_VAL0",  tag: "FIT02-01",  name: "進流流量",       unit: "M3/Hr" },
                { col: "LI022_VAL0",   tag: "LI02-02",   name: "處理設備",   unit: "cm" },
                { col: "LI011_VAL0",   tag: "T02-04",    name: "回收水槽",   unit: "cm" }
            ]
        },
        {
            id: "daf",
            title: "廢油水槽 & DAF 系統",
            className: "group-daf",
            items: [
                { col: "LI012_VAL0",   tag: "LI01-01",   name: "廢水儲槽",   unit: "cm" },
                { col: "LIT000_VAL0",  tag: "LI05-01",   name: "廢油水緩衝", unit: "cm" },
                { col: "FIT000A_VAL0", tag: "FIT05-01A", name: "進流 A",   unit: "M3/Hr" },
                { col: "FIT000B_VAL0", tag: "FIT05-01B", name: "進流 B",   unit: "M3/Hr" },
                { col: "FI003_VAL0",   tag: "FIT05-04",  name: "出口流量",  unit: "M3/Hr" },
                { col: "LI003_VAL0",   tag: "LI05-04",   name: "中間水槽",   unit: "cm" },
                { col: "SLI004_VAL0",  tag: "LI05-06",   name: "油膜檢知",   unit: "cm" }
            ]
        }
    ];

    function checkAlarm(colName, value) {
        let val = parseFloat(value);
        if (isNaN(val)) return "";
        if (colName === "PHI018_VAL0") {
            if (val < 6 || val > 9) return "status-critical";
            if (val < 6.5 || val > 8.5) return "status-warning";
            return "";
        }
        const rule = ALARMS[colName];
        if (rule) {
            if (val >= rule.crit) return "status-critical";
            if (val >= rule.warn) return "status-warning";
        }
        return "";
    }

    function fetchData() {
        fetch(API_URL + "?mode=read&t=" + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if(data.timestamp) {
                    // 只顯示時間 (HH:mm:ss) 節省空間
                    let timeOnly = data.timestamp.split(' ')[1] || data.timestamp;
                    document.getElementById('last-update').innerText = timeOnly;
                }

                let htmlContent = '';

                DASHBOARD_CONFIG.forEach(group => {
                    htmlContent += `
                        <div class="system-group ${group.className}">
                            <div class="system-title">${group.title}</div>
                            <div class="grid">
                    `;

                    group.items.forEach(item => {
                        let val = data[item.col] !== undefined ? data[item.col] : '--';
                        
                        if (!isNaN(val) && val.toString().indexOf('.') !== -1) {
                             val = parseFloat(val).toFixed(1);
                             if(val.endsWith('.0')) val = val.replace('.0', '');
                        }

                        let statusClass = checkAlarm(item.col, val);

                        htmlContent += `
                            <div class="card ${statusClass}">
                                <div class="card-header">
                                    <span class="tag-name">${item.name}</span>
                                    <span class="tag-id">${item.tag}</span>
                                </div>
                                <div class="data-row">
                                    <span class="value">${val}</span>
                                    <span class="unit">${item.unit}</span>
                                </div>
                            </div>
                        `;
                    });

                    htmlContent += `</div></div>`;
                });

                document.getElementById('app').innerHTML = htmlContent;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('last-update').innerText = "斷線";
                document.getElementById('last-update').style.color = "red";
            });
    }

    fetchData();
    setInterval(fetchData, 5000);

</script>

</body>
</html>
