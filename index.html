<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>尖山發電廠 - 廢油水雲端監控</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* 標題區 */
        header { background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-left: 6px solid #007bff; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.6rem; letter-spacing: 1px; }
        .status-box { font-size: 0.9rem; color: #555; background: #e9ecef; padding: 6px 12px; border-radius: 20px; font-weight: bold; }
        
        /* 分區標題 */
        .system-group { margin-bottom: 35px; }
        .system-title { font-size: 1.3rem; color: #343a40; margin-bottom: 15px; padding-left: 12px; border-left: 5px solid #28a745; font-weight: bold; display: flex; align-items: center; }
        .system-title span { background: #d4edda; color: #155724; font-size: 0.8rem; padding: 3px 10px; border-radius: 15px; margin-left: 12px; font-weight: normal; }

        /* 卡片網格 */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        
        /* --- 卡片基礎樣式 --- */
        .card { 
            background: white; 
            border-radius: 8px; 
            padding: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            transition: all 0.3s ease; 
            border: 1px solid #eee; /* 預設邊框 */
            border-top: 4px solid #ccc; /* 預設頂部條 */
            position: relative; 
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

        /* --- 警報顏色樣式 (關鍵修改) --- */
        
        /* 1. 警告 (橘色) */
        .card.status-warning {
            background-color: #fff3cd; /* 淺橘底 */
            border-color: #ffeeba;
            border-top-color: #ffc107 !important; /* 深橘頂條 */
            animation: pulse-orange 2s infinite;
        }
        .card.status-warning .value { color: #856404; }
        .card.status-warning .tag-name { color: #856404; }

        /* 2. 超標 (紅色) */
        .card.status-critical {
            background-color: #f8d7da; /* 淺紅底 */
            border-color: #f5c6cb;
            border-top-color: #dc3545 !important; /* 深紅頂條 */
            animation: pulse-red 1.5s infinite;
        }
        .card.status-critical .value { color: #721c24; font-weight: 900; }
        .card.status-critical .tag-name { color: #721c24; }

        /* 動畫效果 */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        /* 預設顏色條 (如果沒有警報時顯示) */
        .group-filter .card:not(.status-warning):not(.status-critical) { border-top-color: #007bff; }
        .group-sbr .card:not(.status-warning):not(.status-critical) { border-top-color: #6f42c1; }
        .group-daf .card:not(.status-warning):not(.status-critical) { border-top-color: #fd7e14; }

        /* 卡片內容排版 */
        .card-header { margin-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px; }
        .tag-id { font-size: 0.85rem; color: #888; font-family: Consolas, monospace; display: block; margin-bottom: 2px; opacity: 0.7; }
        .tag-name { font-size: 1rem; color: #555; font-weight: bold; }
        
        .data-row { display: flex; align-items: baseline; justify-content: flex-end; }
        .value { font-size: 2rem; font-weight: bold; color: #2c3e50; font-family: 'Arial', sans-serif; }
        .unit { font-size: 0.9rem; color: #888; margin-left: 6px; }
        
        .loading { text-align: center; padding: 50px; color: #aaa; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>尖山發電廠 - 廢油水監控戰情室</h1>
        <div class="status-box">最後更新: <span id="last-update">連線中...</span></div>
    </header>

    <div id="app">
        <div class="loading">正在從雲端同步數據...</div>
    </div>
</div>

<script>
    // ============================================================
    // 1. Google Apps Script 網址 (請確認是最新版)
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzwFRkiITDbICO-zisn_rr-6uT0-DFNeMvgFFYWFTVKHGrZz7K9XbIi18NBW4Gr2Nty/exec"; 
    // ↑↑↑ 注意：請把上面這行換成你自己的 Google 網址！ ↑↑↑

    // ============================================================
    // 2. 定義警報規則 (依照您提供的圖片設定)
    // ============================================================
    // crit: 超過這個值變紅色 (Critical)
    // warn: 超過這個值變橘色 (Warning)
    const ALARMS = {
        "LI018_VAL0":   { warn: 90,  crit: 100 }, // LI01-07 液位
        "SS018_VAL0":   { warn: 20,  crit: 30  }, // SS01-07
        "COD018_VAL0":  { warn: 80,  crit: 100 }, // COD
        "OFD018_VAL0":  { warn: 6,   crit: 10  }, // 油分
        "NH3N018_VAL0": { warn: 30,  crit: 60  }, // 氨氮
        "LI021_VAL0":   { warn: 210, crit: 230 }, // LI02-01 污水收集槽
        // PH值需要特殊邏輯，寫在 checkAlarm 函數裡
    };

    // ============================================================
    // 3. 定義儀表板內容
    // ============================================================
    const DASHBOARD_CONFIG = [
        {
            id: "filter",
            title: "過濾系統",
            className: "group-filter",
            items: [
                { col: "LI018_VAL0",   tag: "LI01-07",   name: "放流水液位",     unit: "cm" },
                { col: "SS018_VAL0",   tag: "SS01-07",   name: "懸浮固體",       unit: "mg/L" },
                { col: "COD018_VAL0",  tag: "COD01-07",  name: "化學需氧量",     unit: "mg/L" },
                { col: "OFD018_VAL0",  tag: "OFD01-07",  name: "油份濃度",       unit: "mg/L" },
                { col: "NH3N018_VAL0", tag: "NH3N01-07", name: "氨氮濃度",       unit: "mg/L" },
                { col: "PHI018_VAL0",  tag: "PH01-07",   name: "酸鹼值",         unit: "" },
                { col: "FI018_VAL0",   tag: "FIT01-07",  name: "放流流量",       unit: "M3/Hr" }
            ]
        },
        {
            id: "sbr",
            title: "SBR 系統",
            className: "group-sbr",
            items: [
                { col: "LI021_VAL0",   tag: "LI02-01",   name: "污水收集槽液位", unit: "cm" },
                { col: "FI021W_VAL0",  tag: "FIT02-01",  name: "進流流量",       unit: "M3/Hr" },
                { col: "LI022_VAL0",   tag: "LI02-02",   name: "處理設備液位",   unit: "cm" },
                { col: "LI011_VAL0",   tag: "T02-04",    name: "回收水槽液位",   unit: "cm" }
            ]
        },
        {
            id: "daf",
            title: "廢油水槽 & DAF 系統",
            className: "group-daf",
            items: [
                { col: "LI012_VAL0",   tag: "LI01-01",   name: "廢水儲槽液位",   unit: "cm" },
                { col: "LIT000_VAL0",  tag: "LI05-01",   name: "廢油水緩衝液位", unit: "cm" },
                { col: "FIT000A_VAL0", tag: "FIT05-01A", name: "廢油水進流 A",   unit: "M3/Hr" },
                { col: "FIT000B_VAL0", tag: "FIT05-01B", name: "廢油水進流 B",   unit: "M3/Hr" },
                { col: "FI003_VAL0",   tag: "FIT05-04",  name: "出口(DAF)流量",  unit: "M3/Hr" },
                { col: "LI003_VAL0",   tag: "LI05-04",   name: "中間水槽液位",   unit: "cm" },
                { col: "SLI004_VAL0",  tag: "LI05-06",   name: "油膜檢知液位",   unit: "cm" }
            ]
        }
    ];

    // 判斷警報狀態的函數
    function checkAlarm(colName, value) {
        let val = parseFloat(value);
        if (isNaN(val)) return "";

        // 1. 特殊處理 PH 值 (雙向警報)
        if (colName === "PHI018_VAL0") {
            if (val < 6 || val > 9) return "status-critical"; // 超標紅色
            if (val < 6.5 || val > 8.5) return "status-warning"; // 警告橘色
            return "";
        }

        // 2. 一般數值判斷 (單向警報)
        const rule = ALARMS[colName];
        if (rule) {
            if (val >= rule.crit) return "status-critical"; // 紅色
            if (val >= rule.warn) return "status-warning";  // 橘色
        }
        return "";
    }

    function fetchData() {
        fetch(API_URL + "?mode=read&t=" + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if(data.timestamp) {
                    document.getElementById('last-update').innerText = data.timestamp;
                }

                let htmlContent = '';

                DASHBOARD_CONFIG.forEach(group => {
                    htmlContent += `
                        <div class="system-group ${group.className}">
                            <div class="system-title">${group.title} <span>${group.items.length} 個監控點</span></div>
                            <div class="grid">
                    `;

                    group.items.forEach(item => {
                        let val = data[item.col] !== undefined ? data[item.col] : '--';
                        
                        // 數值格式化
                        if (!isNaN(val) && val.toString().indexOf('.') !== -1) {
                             val = parseFloat(val).toFixed(1);
                             if(val.endsWith('.0')) val = val.replace('.0', '');
                        }

                        // 取得警報 CSS 類別
                        let statusClass = checkAlarm(item.col, val);

                        htmlContent += `
                            <div class="card ${statusClass}">
                                <div class="card-header">
                                    <span class="tag-id">${item.tag}</span>
                                    <span class="tag-name">${item.name}</span>
                                </div>
                                <div class="data-row">
                                    <span class="value">${val}</span>
                                    <span class="unit">${item.unit}</span>
                                </div>
                            </div>
                        `;
                    });

                    htmlContent += `</div></div>`;
                });

                document.getElementById('app').innerHTML = htmlContent;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('last-update').innerText = "連線逾時";
                document.getElementById('last-update').style.color = "red";
            });
    }

    fetchData();
    setInterval(fetchData, 5000);

</script>

</body>
</html>
