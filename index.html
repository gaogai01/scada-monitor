<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞ñÂ±±ÁôºÈõªÂª† - Âª¢Ê≤πÊ∞¥Èõ≤Á´ØÁõ£Êéß</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS ËÆäÊï∏ÂÆöÁæ© --- */
        :root {
            --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #2c3e50; --text-sub: #666666; --text-value: #2c3e50;
            --border-color: #e0e0e0; --shadow: rgba(0,0,0,0.05);
            --warn-bg: #fff3cd; --warn-text: #856404; --warn-border: #ffc107;
            --crit-bg: #f8d7da; --crit-text: #721c24; --crit-border: #dc3545;
            --run-bg:  #d1e7dd; --run-text:  #0f5132; --run-border:  #198754;
            --gauge-good: #28a745; --gauge-warn: #ffc107; --gauge-bad: #dc3545; --gauge-bg: #e9ecef;
        }
        [data-theme="dark"] {
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --text-sub: #aaaaaa; --text-value: #ffffff;
            --border-color: #333333; --shadow: rgba(0,0,0,0.5);
            --warn-bg: #423605; --warn-text: #ffda6a; --warn-border: #997404;
            --crit-bg: #4c1116; --crit-text: #ff8592; --crit-border: #a81624;
            --run-bg:  #051b11; --run-text:  #75b798; --run-border:  #198754;
            --gauge-bg: #333;
        }

        /* --- Âü∫Á§éÊ®£Âºè --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 5px; transition: background 0.3s; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 5px; }
        
        /* Ê®ôÈ°åÂçÄ */
        header { background: var(--bg-card); padding: 5px 15px; border-radius: 6px; box-shadow: 0 2px 5px var(--shadow); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-left: 5px solid #007bff; }
        h1 { color: var(--text-main); margin: 0; font-size: 1.1rem; letter-spacing: 1px; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        button.btn-ctrl { background: #007bff; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; }
        .status-box { font-size: 0.75rem; color: var(--text-sub); background: var(--border-color); padding: 3px 8px; border-radius: 10px; font-weight: bold; }

        /* --- ÁâàÈù¢ÈÖçÁΩÆ --- */
        #app { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; align-items: start; margin-bottom: 20px; }
        
        .system-group { background: var(--bg-card); border-radius: 10px; padding: 10px; box-shadow: 0 1px 3px var(--shadow); border: 1px solid var(--border-color); }
        
        .system-title { 
            font-size: 1rem; color: #fff; margin-bottom: 10px; padding: 6px 15px; 
            border-radius: 50px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .system-title span { background: rgba(255,255,255,0.25); color: #fff; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; }

        /* È°èËâ≤Ë®≠ÂÆö */
        .group-d01 .system-title { background: linear-gradient(135deg, #007bff, #0056b3); }
        .group-d02 .system-title { background: linear-gradient(135deg, #20c997, #198754); }
        .group-wm01 .system-title { background: linear-gradient(135deg, #17a2b8, #117a8b); }
        .group-wm02 .system-title { background: linear-gradient(135deg, #6f42c1, #59359a); }
        .group-wm05 .system-title { background: linear-gradient(135deg, #fd7e14, #d35400); }
        .group-cds .system-title { background: linear-gradient(135deg, #e83e8c, #c2175b); }
        .group-acc .system-title { background: linear-gradient(135deg, #343a40, #212529); }

        .inner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .card { background: var(--bg-body); border-radius: 6px; padding: 6px 10px; border: 1px solid var(--border-color); border-top: 3px solid #ccc; position: relative; }
        
        .group-d01 .card { border-top-color: #007bff; } .group-wm01 .card { border-top-color: #17a2b8; } .group-wm02 .card { border-top-color: #6f42c1; }
        .group-wm05 .card { border-top-color: #fd7e14; } .group-d02 .card { border-top-color: #20c997; } .group-cds .card { border-top-color: #e83e8c; } .group-acc .card { border-top-color: #343a40; }

        /* Ë≠¶Â†±È°èËâ≤ */
        .card.status-running { background-color: var(--run-bg); border-top-color: var(--run-border) !important; animation: pulse-green 3s infinite; }
        .card.status-running .value, .card.status-running .tag-name { color: var(--run-text); }
        .card.status-warning { background-color: var(--warn-bg); border-top-color: var(--warn-border) !important; animation: pulse-orange 2s infinite; }
        .card.status-warning .value, .card.status-warning .tag-name { color: var(--warn-text); }
        .card.status-critical { background-color: var(--crit-bg); border-top-color: var(--crit-border) !important; animation: pulse-red 1.5s infinite; }
        .card.status-critical .value, .card.status-critical .tag-name { color: var(--crit-text); font-weight: 900; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 3px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.2); } 50% { box-shadow: 0 0 0 2px rgba(25, 135, 84, 0); } 100% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); } }

        .card-header { margin-bottom: 2px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        .tag-name { font-size: 0.8rem; color: var(--text-main); font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65%; }
        .tag-id { font-size: 0.65rem; color: var(--text-sub); font-family: Consolas, monospace; opacity: 0.7; } 
        .data-row { display: flex; align-items: baseline; justify-content: flex-end; margin-top: 2px; margin-bottom: 4px; }
        .value { font-size: 1.4rem; font-weight: bold; color: var(--text-value); font-family: 'Arial', sans-serif; line-height: 1; }
        .unit { font-size: 0.7rem; color: var(--text-sub); margin-left: 2px; }
        
        .gauge-container { height: 5px; width: 100%; background: var(--gauge-bg); border-radius: 3px; position: relative; display: flex; overflow: visible; margin-top: 2px; }
        .gauge-seg { height: 100%; }
        .seg-good { background-color: var(--gauge-good); border-radius: 3px 0 0 3px; }
        .seg-warn { background-color: var(--gauge-warn); }
        .seg-poor { background-color: var(--gauge-bad); border-radius: 0 3px 3px 0; }
        .seg-rev-poor { background-color: var(--gauge-bad); border-radius: 3px 0 0 3px; }
        .seg-rev-warn { background-color: var(--gauge-warn); }
        .seg-rev-good { background-color: var(--gauge-good); border-radius: 0 3px 3px 0; }
        .gauge-marker { position: absolute; top: -2px; width: 2px; height: 9px; background-color: var(--text-main); border: 1px solid var(--bg-card); transform: translateX(-50%); z-index: 2; transition: left 0.5s ease; }

        .loading { grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-sub); font-size: 1rem; }
        
        /* --- ÂúñË°®ÂçÄÂ°ä (Êñ∞Ë®≠Ë®à) --- */
        .chart-section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border-color);
            border-top: 5px solid #007bff;
            margin-bottom: 30px;
        }
        .chart-header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;
        }
        .chart-header h2 { font-size: 1.2rem; color: var(--text-main); margin: 0; }
        
        .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 2px; font-weight: bold; }
        
        select, input[type="date"] { 
            padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); 
            background: var(--bg-body); color: var(--text-main); font-size: 0.9rem; 
        }
        
        .checkbox-container {
            display: flex; flex-wrap: wrap; gap: 10px; max-height: 80px; overflow-y: auto;
            border: 1px solid var(--border-color); padding: 5px; border-radius: 4px; flex: 1;
            min-width: 250px;
        }
        .checkbox-item { display: flex; align-items: center; font-size: 0.8rem; color: var(--text-main); background: var(--bg-body); padding: 2px 6px; border-radius: 4px; }
        .checkbox-item input { margin-right: 5px; }

        @media (max-width: 600px) { 
            #app { grid-template-columns: 1fr; } 
            h1 { font-size: 1rem; } 
            .value { font-size: 1.3rem; } 
            .chart-controls { flex-direction: column; align-items: stretch; }
            .checkbox-container { max-height: 120px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Â∞ñÂ±±ÁôºÈõªÂª† - Âª¢Ê≤πÊ∞¥Áõ£Êéß</h1>
        <div class="header-right">
            <button class="btn-ctrl" onclick="toggleTheme()" id="themeBtn">üåì</button>
            <div class="status-box">Êõ¥Êñ∞: <span id="last-update">...</span></div>
        </div>
    </header>

    <div id="app">
        <div class="loading">Ê≠£Âú®ÂêåÊ≠•Êï∏Êìö...</div>
    </div>

    <div class="chart-section" id="chartSection">
        <div class="chart-header">
            <h2>Ê≠∑Âè≤Ë∂®Âã¢ÂàÜÊûê</h2>
            <div class="chart-controls">
                <div class="control-group">
                    <label>Âü∫Ê∫ñÊó•Êúü</label>
                    <input type="date" id="chartDate" onchange="updateChart()">
                </div>
                <div class="control-group">
                    <label>ÊôÇÈñìÁØÑÂúç</label>
                    <select id="timeRange" onchange="updateChart()">
                        <option value="24">24 Â∞èÊôÇ</option>
                        <option value="168">7 Â§©</option>
                        <option value="720">30 Â§© (Êúà)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Êï∏ÊìöÈ°ûÂà•</label>
                    <select id="categorySelect" onchange="renderCheckboxes()">
                        <option value="level">Ê∂≤‰Ωç</option>
                        <option value="flow">ÊµÅÈáè</option>
                        <option value="quality">Ê∞¥Ë≥™</option>
                        <option value="temp">Ê∫´Â∫¶</option>
                    </select>
                </div>
                <div class="control-group" style="flex: 2;">
                    <label>Èªû‰ΩçÈÅ∏Êìá</label>
                    <div id="tagCheckboxes" class="checkbox-container"></div>
                </div>
            </div>
        </div>
        <div style="position: relative; height:450px; width:100%">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzwFRkiITDbICO-zisn_rr-6uT0-DFNeMvgFFYWFTVKHGrZz7K9XbIi18NBW4Gr2Nty/exec"; 
    // ‚Üë‚Üë‚Üë Ë´ãÁ¢∫Ë™çÈÄôÊòØÊÇ®ÁöÑÁ∂≤ÂùÄ ‚Üë‚Üë‚Üë

    const ALARMS = {
        "LI018_VAL0":   { max: 120, warn: 90,  crit: 100 },
        "SS018_VAL0":   { max: 60,  warn: 20,  crit: 30  },
        "COD018_VAL0":  { max: 150, warn: 80,  crit: 100 },
        "OFD018_VAL0":  { max: 20,  warn: 6,   crit: 10  },
        "NH3N018_VAL0": { max: 80,  warn: 30,  crit: 60  },
        "LI021_VAL0":   { max: 500, warn: 410, crit: 430 },
        "LI012_VAL0":   { max: 300, warn: 210, crit: 230 },
        "LIT000_VAL0":  { max: 150, warn: 90,  crit: 120 },
        "D02_TEMP":     { max: 50,  warn: 35,  crit: 38  },
        "LI003_VAL0":   { max: 120, warn: 95,  crit: 100 }, 
        "LI022_VAL0":   { max: 250, warn: 186, crit: 196 }, 
        "LI011_VAL0":   { max: 250, warn: 180, crit: 200 }, 
        "LI043_VAL0":   { max: 100, warn: 30,  crit: 20 },
        "LI044_VAL0":   { max: 100, warn: 30,  crit: 20 },
        "LI048_VAL0":   { max: 100, warn: 30,  crit: 20 },
        "LI049_VAL0":   { max: 100, warn: 30,  crit: 20 },
        "FI000A_Q_VAL0_DAILY": { max: 20, warn: 18, crit: 19 }, 
        "FI000B_Q_VAL0_DAILY": { max: 20, warn: 18, crit: 19 }, 
        "FI003_Q_VAL0_DAILY":  { max: 20, warn: 18, crit: 19 }, 
        "FI012_Q_VAL0_DAILY":  { max: 24, warn: 22, crit: 24 }, 
        "FI018_Q_VAL0_DAILY":  { max: 40, warn: 36, crit: 38 }, 
        "FI018B_Q_VAL0_DAILY": { max: 40, warn: 36, crit: 38 }, 
        "FI021W_Q_VAL0_DAILY": { max: 16, warn: 14, crit: 15 }, 
        "FI031_Q_VAL0_DAILY":  { max: 20, warn: 16, crit: 18 }, 
    };

    const DASHBOARD_CONFIG = [
        {
            id: "d01", title: "D01 ÊîæÊµÅÊ∞¥Ê∞¥Ë≥™", className: "group-d01",
            items: [
                { col: "SS018_VAL0",   tag: "SS01-07",   name: "Êá∏ÊµÆÂõ∫È´î",       unit: "mg/L", cat: "quality" },
                { col: "COD018_VAL0",  tag: "COD01-07",  name: "ÂåñÂ≠∏ÈúÄÊ∞ßÈáè",     unit: "mg/L", cat: "quality" },
                { col: "OFD018_VAL0",  tag: "OFD01-07",  name: "Ê≤π‰ªΩÊøÉÂ∫¶",       unit: "mg/L", cat: "quality" },
                { col: "NH3N018_VAL0", tag: "NH3N01-07", name: "Ê∞®Ê∞ÆÊøÉÂ∫¶",       unit: "mg/L", cat: "quality" },
                { col: "PHI018_VAL0",  tag: "PH01-07",   name: "ÈÖ∏ÈπºÂÄº",         unit: "",     cat: "quality" },
                { col: "LI018_VAL0",   tag: "LI01-07",   name: "Ê™¢Áü•ÊßΩÊ∂≤‰Ωç",     unit: "cm",   cat: "level" }
            ]
        },
        {
            id: "d02", title: "D02 Êú™Êé•Ëß∏ÂÜ∑ÂçªÊ∞¥", className: "group-d02",
            items: [
                { col: "D02_TEMP",     tag: "D02-Temp",  name: "D02Ê∞¥Ê∫´",       unit: "¬∞C",   cat: "temp" },
                { col: "D02_FLOW",     tag: "D02-Flow",  name: "D02Ê∞¥Èáè",       unit: "M3",   cat: "flow" }
            ]
        },
        {
            id: "wm01", title: "WM01 ‰∫ãÊ•≠Âª¢Ê∞¥", className: "group-wm01",
            items: [
                { col: "LI012_VAL0",   tag: "LI01-01",   name: "Ë™øÂãªÊßΩÊ∂≤‰Ωç",     unit: "cm",   cat: "level" },
                { col: "FI012_VAL0",   tag: "FIT01-01",  name: "Ë™øÂãªÊßΩÂá∫Âè£",     unit: "M3/Hr",cat: "flow" },
                { col: "PHI013_VAL0",  tag: "PH01-03",   name: "Á¨¨‰∏ÄÈÖ∏ÈπºÊßΩPH",   unit: "",     cat: "quality" },
                { col: "PHI014_VAL0",  tag: "PH01-04",   name: "ËÜ†ÂáùÊßΩPH",       unit: "",     cat: "quality" },
                { col: "PHI017_VAL0",  tag: "PH01-06",   name: "Á¨¨‰∫åÈÖ∏ÈπºÊßΩPH",   unit: "",     cat: "quality" },
                { col: "FI018_VAL0",   tag: "FIT01-07",  name: "D01ÊµÅÈáè",       unit: "M3/Hr",cat: "flow" }
            ]
        },
        {
            id: "wm02", title: "WM02 ÁîüÊ¥ªÊ±°Ê∞¥", className: "group-wm02",
            items: [
                { col: "LI021_VAL0",   tag: "LI02-01",   name: "ÁîüÊ¥ªÊ±°Ê∞¥ÂÑ≤ÊßΩ",   unit: "cm",   cat: "level" },
                { col: "FI021W_VAL0",  tag: "FIT02-01",  name: "Âá∫Âè£ÊµÅÈáè",       unit: "M3/Hr",cat: "flow" },
                { col: "LI022_VAL0",   tag: "LI02-02",   name: "SBRÊ∂≤‰Ωç",        unit: "cm",   cat: "level" },
                { col: "FI018B_VAL0",  tag: "FIT01-08",  name: "ÂõûÊî∂Ê∞¥ÊµÅÈáè",     unit: "M3/Hr",cat: "flow" },
                { col: "LI011_VAL0",   tag: "T02-04",    name: "ÂõûÊî∂Ê∞¥ÊßΩÊ∂≤‰Ωç",   unit: "cm",   cat: "level" }
            ]
        },
        {
            id: "wm05", title: "WM05 Âê´Ê≤π‰∫ãÊ•≠Âª¢Ê∞¥", className: "group-wm05",
            items: [
                { col: "FIT000B_VAL0", tag: "FIT05-01B", name: "APIÈÄ≤Âè£ÊµÅÈáè",    unit: "M3/Hr",cat: "flow" },
                { col: "LIT000_VAL0",  tag: "LI05-01",   name: "‰∫åÊÆµÂºèAPIÊ∂≤‰Ωç",  unit: "cm",   cat: "level" },
                { col: "FIT000A_VAL0", tag: "FIT05-01A", name: "APIÂá∫Âè£ÊµÅÈáè",    unit: "M3/Hr",cat: "flow" },
                { col: "LI003_VAL0",   tag: "LI05-04",   name: "‰∏≠ÈñìÊ∞¥ÊßΩÊ∂≤‰Ωç",   unit: "cm",   cat: "level" },
                { col: "FI003_VAL0",   tag: "FIT05-04",  name: "DAFÈÄ≤Âè£ÊµÅÈáè",    unit: "M3/Hr",cat: "flow" },
                { col: "PHI015_VAL0",  tag: "PH05-05",   name: "ÈùúÊÖãÊî™ÊãåÁÆ°PH",   unit: "",     cat: "quality" }
            ]
        },
        {
            id: "cds", title: "CDS Âä†Ëó•Á≥ªÁµ±", className: "group-cds",
            items: [
                { col: "LI044_VAL0",   tag: "LI044",     name: "ÈπºÊßΩÊ∂≤‰Ωç",       unit: "cm",   cat: "level" },
                { col: "LI048_VAL0",   tag: "LI048",     name: "ÂáùËÜ†ÂÑ≤ÊßΩÊ∂≤‰Ωç",   unit: "cm",   cat: "level" },
                { col: "LI049_VAL0",   tag: "LI049",     name: "PACÂÑ≤ÊßΩÊ∂≤‰Ωç",    unit: "cm",   cat: "level" },
                { col: "LI043_VAL0",   tag: "LI043",     name: "ÈÖ∏ÊßΩÊ∂≤‰Ωç",       unit: "cm",   cat: "level" }
            ]
        },
        {
            id: "acc", title: "ACC ÊØèÊó•Á¥ØÁ©çÊµÅÈáè (‰ªäÊó•)", className: "group-acc",
            items: [
                { col: "FI000A_Q_VAL0_DAILY", tag: "FI000A_Q", name: "APIÂá∫Âè£Êó•ÊµÅÈáè", unit: "M3", cat: "flow" },
                { col: "FI000B_Q_VAL0_DAILY", tag: "FI000B_Q", name: "APIÈÄ≤Âè£Êó•ÊµÅÈáè", unit: "M3", cat: "flow" },
                { col: "FI003_Q_VAL0_DAILY",  tag: "FI003_Q",  name: "DAFÈÄ≤Âè£Êó•ÊµÅÈáè", unit: "M3", cat: "flow" },
                { col: "FI012_Q_VAL0_DAILY",  tag: "FI012_Q",  name: "Ë™øÂãªÊßΩÂá∫Êó•ÊµÅÈáè",unit: "M3", cat: "flow" },
                { col: "FI018_Q_VAL0_DAILY",  tag: "FI018_Q",  name: "D01ÊîæÊµÅÊó•ÊµÅÈáè", unit: "M3", cat: "flow" },
                { col: "FI018B_Q_VAL0_DAILY", tag: "FI018B_Q", name: "ÂõûÊî∂Ê∞¥Êó•ÊµÅÈáè",  unit: "M3", cat: "flow" },
                { col: "FI021W_Q_VAL0_DAILY", tag: "FI021W_Q", name: "ÁîüÊ¥ªÊ±°Ê∞¥Êó•ÊµÅÈáè",unit: "M3", cat: "flow" },
                { col: "FI031_Q_VAL0_DAILY",  tag: "FI031_Q",  name: "Ê±°Ê≥•ÊßΩÂá∫Êó•ÊµÅÈáè",unit: "M3", cat: "flow" }
            ]
        }
    ];

    function applyDisplayLimit(colName, value) {
        let val = parseFloat(value); if (isNaN(val)) return value;
        if (colName === "SS018_VAL0" && val > 27) return 27;
        if (colName === "COD018_VAL0" && val > 90) return 90;
        if (colName === "OFD018_VAL0" && val > 10) return 9;
        return value;
    }

    function getGaugeHTML(colName, value) {
        let val = parseFloat(value); if (isNaN(val)) return "";
        let rule = ALARMS[colName];
        if (colName.indexOf("PHI") !== -1) {
            let pct = (val / 14) * 100;
            let colorVar = "var(--gauge-good)";
            if (val < 6 || val > 9) colorVar = "var(--gauge-bad)"; else if (val < 6.5 || val > 8.5) colorVar = "var(--gauge-warn)";
            return `<div class="gauge-container"><div style="width: ${pct}%; background-color: ${colorVar}; height:100%; border-radius:3px;"></div><div class="gauge-marker" style="left: ${pct}%"></div></div>`;
        }
        if (rule && rule.max) {
            let max = rule.max;
            let valPct = Math.min((val / max) * 100, 100);
            let isLowAlarm = rule.warn > rule.crit;
            if (isLowAlarm) {
                let critPct = (rule.crit / max) * 100; let warnPct = (rule.warn / max) * 100;
                return `<div class="gauge-container"><div class="gauge-seg seg-rev-poor" style="width: ${critPct}%"></div><div class="gauge-seg seg-rev-warn" style="width: ${warnPct - critPct}%"></div><div class="gauge-seg seg-rev-good" style="width: ${100 - warnPct}%"></div><div class="gauge-marker" style="left: ${valPct}%"></div></div>`;
            } else {
                let warnPct = (rule.warn / max) * 100; let critPct = (rule.crit / max) * 100;
                return `<div class="gauge-container"><div class="gauge-seg seg-good" style="width: ${warnPct}%"></div><div class="gauge-seg seg-warn" style="width: ${critPct - warnPct}%"></div><div class="gauge-seg seg-poor" style="width: ${100 - critPct}%"></div><div class="gauge-marker" style="left: ${valPct}%"></div></div>`;
            }
        }
        return "";
    }

    function checkAlarm(colName, value) {
        let val = parseFloat(value); if (isNaN(val)) return "";
        if (colName.indexOf("PHI") !== -1) { if (val < 6 || val > 9) return "status-critical"; if (val < 6.5 || val > 8.5) return "status-warning"; return ""; }
        const rule = ALARMS[colName];
        if (rule) {
            let isLowAlarm = rule.warn > rule.crit;
            if (isLowAlarm) { if (val <= rule.crit) return "status-critical"; if (val <= rule.warn) return "status-warning"; }
            else { if (val >= rule.crit) return "status-critical"; if (val >= rule.warn) return "status-warning"; }
        }
        if (DASHBOARD_CONFIG.some(g => g.items.some(i => i.col === colName && i.unit === "M3/Hr"))) {
            if (val > 0) { if (!rule || (val < rule.warn)) return "status-running"; }
        }
        return "";
    }

    function fetchData() { fetch(API_URL + "?mode=read&t=" + new Date().getTime()).then(response => response.json()).then(data => { if(data.timestamp) document.getElementById('last-update').innerText = data.timestamp.split(' ')[1]; let htmlContent = ''; DASHBOARD_CONFIG.forEach(group => { htmlContent += `<div class="system-group ${group.className}"><div class="system-title">${group.title} <span>${group.items.length}</span></div><div class="inner-grid">`; group.items.forEach(item => { let val = data[item.col] !== undefined ? data[item.col] : '--'; val = applyDisplayLimit(item.col, val); if (!isNaN(val) && val.toString().indexOf('.') !== -1) { val = parseFloat(val).toFixed(1); if(val.endsWith('.0')) val = val.replace('.0', ''); } let statusClass = checkAlarm(item.col, val); let gaugeHTML = getGaugeHTML(item.col, val); htmlContent += `<div class="card ${statusClass}"><div class="card-header"><span class="tag-name">${item.name}</span><span class="tag-id">${item.tag}</span></div><div class="data-row"><span class="value">${val}</span><span class="unit">${item.unit}</span></div>${gaugeHTML}</div>`; }); htmlContent += `</div></div>`; }); document.getElementById('app').innerHTML = htmlContent; }).catch(err => console.error(err)); }
    setInterval(fetchData, 5000); fetchData();
    function toggleTheme() { const body = document.body; const newTheme = body.getAttribute("data-theme") === "dark" ? "light" : "dark"; body.setAttribute("data-theme", newTheme); localStorage.setItem("theme", newTheme); document.getElementById("themeBtn").innerHTML = newTheme === "dark" ? "‚òÄÔ∏è" : "üåì"; if(myChart) updateChart(); }
    const savedTheme = localStorage.getItem("theme"); if (savedTheme) { document.body.setAttribute("data-theme", savedTheme); document.getElementById("themeBtn").innerHTML = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåì"; }
    
    // --- ÂúñË°®ÈÇèËºØ (Âê´Ë≠¶Â†±Á∑ö) ---
    let historyData = null; let myChart = null; 
    
    // Ë®≠ÂÆöÊó•ÊúüÈÅ∏ÊìáÂô®È†êË®≠ÁÇ∫‰ªäÂ§©
    document.getElementById('chartDate').valueAsDate = new Date();

    function openChartModal() { 
        document.getElementById('chartSection').scrollIntoView({behavior: "smooth"});
        renderCheckboxes(); 
        
        // È†êË®≠ÈÅ∏Âèñ "Ê∂≤‰Ωç" ‰∏¶ÂãæÈÅ∏ "LIT000_VAL0" (‰∫åÊÆµÂºèAPIÊ∂≤‰Ωç)
        document.getElementById('categorySelect').value = 'level';
        renderCheckboxes(); // ÈáçÊñ∞Ê∏≤Êüì checkbox
        
        // Âº∑Âà∂ÂãæÈÅ∏ LIT000
        setTimeout(() => {
            const defaultChk = document.querySelector('input[value="LIT000_VAL0"]');
            if(defaultChk) {
                defaultChk.checked = true;
                if (!historyData) fetchHistory(); // ËºâÂÖ•Ë≥áÊñô
                else updateChart();
            }
        }, 100);
    }

    function fetchHistory() { fetch(API_URL + "?mode=history").then(res => res.json()).then(json => { historyData = json; updateChart(); }); }
    
    function renderCheckboxes() { 
        const cat = document.getElementById('categorySelect').value; 
        const container = document.getElementById('tagCheckboxes'); 
        container.innerHTML = ''; 
        let items = []; 
        DASHBOARD_CONFIG.forEach(group => { group.items.forEach(item => { if (item.cat === cat) items.push(item); }); }); 
        items.forEach((item) => { 
            container.innerHTML += `<div class="checkbox-item"><input type="checkbox" value="${item.col}" id="chk_${item.col}" onchange="updateChart()"><label for="chk_${item.col}">${item.name} (${item.tag})</label></div>`; 
        }); 
    } 
    
    function updateChart() {
        if (!historyData) return;
        const timeRangeHours = parseInt(document.getElementById('timeRange').value);
        const selectedDateStr = document.getElementById('chartDate').value;
        const selectedDate = new Date(selectedDateStr);
        // Ë®≠ÂÆöÂü∫Ê∫ñÊôÇÈñìÁÇ∫Ë©≤Êó•ÊúüÁöÑ 23:59:59 (ÊâçËÉΩÂåÖÂê´Áï∂Â§©ÊâÄÊúâÊï∏Êìö)
        const baseTime = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59).getTime();

        const headers = historyData.headers;
        const rawRows = historyData.data;
        const checkboxes = document.querySelectorAll('#tagCheckboxes input:checked');
        const selectedCols = [];
        checkboxes.forEach(chk => { 
            const idx = headers.indexOf(chk.value); 
            if (idx !== -1) selectedCols.push({ idx: idx, label: chk.parentNode.textContent.trim(), key: chk.value, data: [] }); 
        });
        
        const labels = [];
        rawRows.forEach(row => {
            let timeStr = row[0]; 
            let rowDate = new Date(timeStr.replace(/-/g, "/")); // Áõ∏ÂÆπÊÄß‰øÆÊ≠£
            let rowTime = rowDate.getTime();
            let diffHours = (baseTime - rowTime) / 1000 / 60 / 60;
            
            // ÈÇèËºØÔºöË≥áÊñôÊôÇÈñìÂøÖÈ†àÂú® (Âü∫Ê∫ñÊôÇÈñì - ÁØÑÂúç) Âà∞ (Âü∫Ê∫ñÊôÇÈñì) ‰πãÈñì
            if (diffHours >= 0 && diffHours <= timeRangeHours) {
                let label = rowDate.getMonth()+1 + "/" + rowDate.getDate() + " " + rowDate.getHours() + ":" + (rowDate.getMinutes()<10?'0':'') + rowDate.getMinutes();
                labels.push(label); 
                selectedCols.forEach(col => { col.data.push(row[col.idx]); });
            }
        });

        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        const isDark = document.body.getAttribute("data-theme") === "dark";
        const gridColor = isDark ? '#444' : '#ddd'; const textColor = isDark ? '#eee' : '#666';
        const colors = ['#007bff', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#17a2b8', '#e83e8c', '#343a40'];
        
        let datasets = selectedCols.map((col, i) => ({ label: col.label, data: col.data, borderColor: colors[i % colors.length], borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 }));

        if (selectedCols.length === 1) {
            const rule = ALARMS[selectedCols[0].key];
            if (rule) {
                if (rule.warn) { datasets.push({ label: 'Ë≠¶Âëä (' + rule.warn + ')', data: new Array(labels.length).fill(rule.warn), borderColor: '#ffc107', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, fill: false }); }
                if (rule.crit) { datasets.push({ label: 'Ë∂ÖÈôê (' + rule.crit + ')', data: new Array(labels.length).fill(rule.crit), borderColor: '#dc3545', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, fill: false }); }
            }
        }

        Chart.defaults.color = textColor; Chart.defaults.borderColor = gridColor;
        myChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxTicksLimit: 10 } } }, plugins: { legend: { labels: { color: textColor } } } } });
    }
    
    // ÂàùÂßãÂåñ
    openChartModal();
</script>

</body>
</html>
