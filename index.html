<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´é›²ç«¯ç›£æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS è®Šæ•¸å®šç¾© (æ–¹ä¾¿åˆ‡æ›æ·±æ·ºè‰²) --- */
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #666666;
            --text-value: #2c3e50;
            --border-color: #e0e0e0;
            --shadow: rgba(0,0,0,0.05);
            
            /* è­¦å ±é¡è‰² (æ·ºè‰²æ¨¡å¼) */
            --warn-bg: #fff3cd; --warn-text: #856404; --warn-border: #ffc107;
            --crit-bg: #f8d7da; --crit-text: #721c24; --crit-border: #dc3545;
        }

        /* --- æ·±è‰²æ¨¡å¼è®Šæ•¸ --- */
        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #aaaaaa;
            --text-value: #ffffff;
            --border-color: #333333;
            --shadow: rgba(0,0,0,0.5);

            /* è­¦å ±é¡è‰² (æ·±è‰²æ¨¡å¼ - é¡è‰²åŠ æ·±ä»¥å…åˆºçœ¼) */
            --warn-bg: #423605; --warn-text: #ffda6a; --warn-border: #997404;
            --crit-bg: #4c1116; --crit-text: #ff8592; --crit-border: #a81624;
        }

        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 5px; transition: background 0.3s; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 5px; }
        
        /* æ¨™é¡Œå€ (Header) */
        header { 
            background: var(--bg-card); padding: 5px 15px; border-radius: 6px; 
            box-shadow: 0 2px 5px var(--shadow); display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 8px; border-left: 5px solid #007bff; 
        }
        h1 { color: var(--text-main); margin: 0; font-size: 1.1rem; letter-spacing: 1px; }
        
        .header-right { display: flex; align-items: center; gap: 8px; }
        button.btn-ctrl { 
            background: #007bff; color: white; border: none; padding: 4px 10px; 
            border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;
        }
        button.btn-ctrl:hover { opacity: 0.9; }
        .status-box { font-size: 0.75rem; color: var(--text-sub); background: var(--border-color); padding: 3px 8px; border-radius: 10px; font-weight: bold; }

        /* --- ä¸»ç‰ˆé¢é…ç½® (Grid Layout) --- */
        /* é€™é‚Šè¨­å®šè®“ä¸åŒç³»çµ±å¯ä»¥ä¸¦æ’é¡¯ç¤ºï¼Œé”åˆ°ä¸€é çœ‹å®Œå…¨éƒ¨ */
        #app {
            display: grid;
            /* é›»è…¦ç‰ˆï¼šè‡ªå‹•å¡«æ»¿ï¼Œæ¯æ¬„æœ€å°å¯¬åº¦ 280px (ç´„å¯æ”¾3-4æ¬„) */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 8px;
            align-items: start; /* é ä¸Šå°é½Š */
        }

        /* ç³»çµ±å€å¡Š */
        .system-group { 
            background: var(--bg-card); 
            border-radius: 6px; 
            padding: 8px; 
            box-shadow: 0 1px 3px var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .system-title { 
            font-size: 0.95rem; color: var(--text-main); margin-bottom: 6px; 
            padding-left: 8px; border-left: 4px solid #28a745; font-weight: bold; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .system-title span { background: var(--border-color); color: var(--text-sub); font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; font-weight: normal; }

        /* å¡ç‰‡ç¶²æ ¼ (ç³»çµ±å…§éƒ¨) */
        .inner-grid { 
            display: grid; 
            /* å¡ç‰‡è®Šå¾—æ›´å°æ›´ç·Šæ¹Š */
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 6px; 
        }
        
        /* æ•¸æ“šå¡ç‰‡ */
        .card { 
            background: var(--bg-body); /* åœ¨å¡ç‰‡ç¾¤çµ„å…§ç¨å¾®åç™½ */
            border-radius: 4px; padding: 5px 8px; 
            border: 1px solid var(--border-color); 
            border-top: 3px solid #ccc; 
            position: relative; 
        }
        
        /* ç³»çµ±é¡è‰²æ¢ */
        .group-d01 .card  { border-top-color: #007bff; }
        .group-wm01 .card { border-top-color: #17a2b8; }
        .group-wm02 .card { border-top-color: #6f42c1; }
        .group-wm05 .card { border-top-color: #fd7e14; }
        .group-d02 .card  { border-top-color: #20c997; }
        .group-cds .card  { border-top-color: #e83e8c; }

        /* è­¦å ±é¡è‰²å‹•ç•« */
        .card.status-warning { background-color: var(--warn-bg); border-top-color: var(--warn-border) !important; animation: pulse-orange 2s infinite; }
        .card.status-warning .value, .card.status-warning .tag-name { color: var(--warn-text); }
        
        .card.status-critical { background-color: var(--crit-bg); border-top-color: var(--crit-border) !important; animation: pulse-red 1.5s infinite; }
        .card.status-critical .value, .card.status-critical .tag-name { color: var(--crit-text); font-weight: 900; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 3px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        /* å¡ç‰‡å…§å®¹ - å­—é«”æ¥µè‡´ç¸®å° */
        .card-header { margin-bottom: 2px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        .tag-name { font-size: 0.8rem; color: var(--text-main); font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tag-id { font-size: 0.65rem; color: var(--text-sub); font-family: Consolas, monospace; opacity: 0.7; } 
        
        .data-row { display: flex; align-items: baseline; justify-content: flex-end; margin-top: 2px; }
        .value { font-size: 1.4rem; font-weight: bold; color: var(--text-value); font-family: 'Arial', sans-serif; line-height: 1; }
        .unit { font-size: 0.7rem; color: var(--text-sub); margin-left: 2px; }
        
        .loading { grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-sub); font-size: 1rem; }

        /* æ‰‹æ©Ÿç‰ˆè¨­å®š (å¼·åˆ¶å–®æ¬„å †ç–Šï¼Œå…§éƒ¨é›™æ¬„) */
        @media (max-width: 600px) {
            #app { grid-template-columns: 1fr; } /* ç³»çµ±ä¸Šä¸‹æ’ */
            .inner-grid { grid-template-columns: 1fr 1fr; } /* å¡ç‰‡å·¦å³æ’ */
            h1 { font-size: 1rem; }
            .value { font-size: 1.3rem; }
            .modal-content { margin: 20% auto; width: 95%; padding: 15px; }
            .chart-controls { flex-direction: column; }
        }

        /* Modal æ¨£å¼ (æ”¯æ´æ·±è‰²) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--bg-card); color: var(--text-main); margin: 3% auto; padding: 15px; border-radius: 8px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }
        
        .chart-controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; background: var(--bg-body); padding: 8px; border-radius: 5px; }
        .control-group { display: flex; flex-direction: column; min-width: 100px; flex: 1; }
        .control-group label { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 3px; font-weight: bold; }
        select { padding: 4px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); font-size: 0.85rem; }
        .checkbox-list { max-height: 80px; overflow-y: auto; border: 1px solid var(--border-color); background: var(--bg-card); padding: 4px; border-radius: 4px; }
        .checkbox-item { display: flex; align-items: center; font-size: 0.8rem; margin-bottom: 2px; color: var(--text-main); }
        .checkbox-item input { margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´ç›£æ§</h1>
        <div class="header-right">
            <button class="btn-ctrl" onclick="toggleTheme()" id="themeBtn">ğŸŒ“</button>
            <button class="btn-ctrl" onclick="openChartModal()">ğŸ“Š è¶¨å‹¢åœ–</button>
            <div class="status-box">æ›´æ–°: <span id="last-update">...</span></div>
        </div>
    </header>

    <div id="app">
        <div class="loading">æ­£åœ¨åŒæ­¥æ•¸æ“š...</div>
    </div>
</div>

<div id="chartModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ­·å²è¶¨å‹¢åˆ†æ</h3>
            <span class="close-btn" onclick="closeChartModal()">&times;</span>
        </div>
        <div class="chart-controls">
            <div class="control-group">
                <label>1. æ™‚é–“ç¯„åœ</label>
                <select id="timeRange" onchange="updateChart()">
                    <option value="24">éå» 24 å°æ™‚</option>
                    <option value="168">éå» 7 å¤©</option>
                    <option value="720">éå» 30 å¤©</option>
                </select>
            </div>
            <div class="control-group">
                <label>2. æ•¸æ“šé¡åˆ¥</label>
                <select id="categorySelect" onchange="renderCheckboxes()">
                    <option value="level">æ¶²ä½ (cm)</option>
                    <option value="flow">æµé‡ (M3/Hr)</option>
                    <option value="quality">æ°´è³ªç›£æ¸¬</option>
                    <option value="temp">æº«åº¦ (Â°C)</option>
                </select>
            </div>
            <div class="control-group" style="flex: 2;">
                <label>3. é¸æ“‡é»ä½</label>
                <div id="tagCheckboxes" class="checkbox-list"></div>
            </div>
        </div>
        <div style="position: relative; height:300px; width:100%">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // 1. Google Apps Script ç¶²å€
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzwFRkiITDbICO-zisn_rr-6uT0-DFNeMvgFFYWFTVKHGrZz7K9XbIi18NBW4Gr2Nty/exec"; 
    // â†‘â†‘â†‘ è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„ç¶²å€ â†‘â†‘â†‘

    // ============================================================
    // 2. è­¦å ±è¦å‰‡
    // ============================================================
    const ALARMS = {
        "LI018_VAL0":   { warn: 90,  crit: 100 },
        "SS018_VAL0":   { warn: 20,  crit: 30  },
        "COD018_VAL0":  { warn: 80,  crit: 100 },
        "OFD018_VAL0":  { warn: 6,   crit: 10  },
        "NH3N018_VAL0": { warn: 30,  crit: 60  },
        "LI021_VAL0":   { warn: 410, crit: 430 },
        "LI012_VAL0":   { warn: 210, crit: 230 },
        "LIT000_VAL0":  { warn: 90,  crit: 120 },
        "D02_TEMP":     { warn: 35,  crit: 38  },
    };

    // ============================================================
    // 3. å„€è¡¨æ¿å…§å®¹ (å·²ä¾ç…§æ–°é †åºèª¿æ•´)
    // ============================================================
    const DASHBOARD_CONFIG = [
        {
            id: "d01", title: "D01 æ”¾æµæ°´æ°´è³ª", className: "group-d01",
            items: [
                { col: "SS018_VAL0",   tag: "SS01-07",   name: "æ‡¸æµ®å›ºé«”",       unit: "mg/L", cat: "quality" },
                { col: "COD018_VAL0",  tag: "COD01-07",  name: "åŒ–å­¸éœ€æ°§é‡",     unit: "mg/L", cat: "quality" },
                { col: "OFD018_VAL0",  tag: "OFD01-07",  name: "æ²¹ä»½æ¿ƒåº¦",       unit: "mg/L", cat: "quality" },
                { col: "NH3N018_VAL0", tag: "NH3N01-07", name: "æ°¨æ°®æ¿ƒåº¦",       unit: "mg/L", cat: "quality" },
                { col: "PHI018_VAL0",  tag: "PH01-07",   name: "é…¸é¹¼å€¼",         unit: "",     cat: "quality" }
            ]
        },
        {
            id: "d02", title: "D02 æœªæ¥è§¸å†·å»æ°´", className: "group-d02",
            items: [
                { col: "D02_TEMP",     tag: "D02-Temp",  name: "æ”¾æµæ°´æº«",       unit: "Â°C",   cat: "temp" },
                { col: "D02_FLOW",     tag: "D02-Flow",  name: "æ”¾æµæ°´é‡",       unit: "M3",   cat: "flow" }
            ]
        },
        {
            id: "wm01", title: "WM01 äº‹æ¥­å»¢æ°´", className: "group-wm01",
            items: [
                { col: "LI012_VAL0",   tag: "LI01-01",   name: "å»¢æ°´å„²æ§½æ¶²ä½",   unit: "cm",   cat: "level" },
                { col: "PHI013_VAL0",  tag: "PH01-03",   name: "ç¬¬ä¸€é…¸é¹¼æ§½PH",   unit: "",     cat: "quality" },
                { col: "PHI014_VAL0",  tag: "PH01-04",   name: "è† å‡æ§½PH",       unit: "",     cat: "quality" },
                { col: "PHI017_VAL0",  tag: "PH01-06",   name: "ç¬¬äºŒé…¸é¹¼æ§½PH",   unit: "",     cat: "quality" },
                { col: "LI018_VAL0",   tag: "LI01-07",   name: "æ”¾æµæ°´æ¶²ä½",     unit: "cm",   cat: "level" },
                { col: "FI018_VAL0",   tag: "FIT01-07",  name: "æ”¾æµæµé‡",       unit: "M3/Hr",cat: "flow" }
            ]
        },
        {
            id: "wm02", title: "WM02 ç”Ÿæ´»æ±¡æ°´", className: "group-wm02",
            items: [
                { col: "LI021_VAL0",   tag: "LI02-01",   name: "ç”Ÿæ´»æ±¡æ°´å„²æ§½",   unit: "cm",   cat: "level" },
                { col: "FI021W_VAL0",  tag: "FIT02-01",  name: "å‡ºå£æµé‡",       unit: "M3/Hr",cat: "flow" },
                { col: "LI022_VAL0",   tag: "LI02-02",   name: "SBRæ¶²ä½",        unit: "cm",   cat: "level" },
                { col: "LI011_VAL0",   tag: "T02-04",    name: "å›æ”¶æ°´æ§½æ¶²ä½",   unit: "cm",   cat: "level" }
            ]
        },
        {
            id: "wm05", title: "WM05 å«æ²¹äº‹æ¥­å»¢æ°´", className: "group-wm05",
            items: [
                // é †åºèª¿æ•´ï¼šAPIé€²å£ -> äºŒæ®µAPI -> APIå‡ºå£ -> ä¸­é–“æ°´æ§½ -> DAFé€²å£ -> éœæ…‹PH
                { col: "FIT000B_VAL0", tag: "FIT05-01B", name: "APIé€²å£æµé‡",    unit: "M3/Hr",cat: "flow" },
                { col: "LIT000_VAL0",  tag: "LI05-01",   name: "äºŒæ®µå¼APIæ¶²ä½",  unit: "cm",   cat: "level" },
                { col: "FIT000A_VAL0", tag: "FIT05-01A", name: "APIå‡ºå£æµé‡",    unit: "M3/Hr",cat: "flow" },
                { col: "LI003_VAL0",   tag: "LI05-04",   name: "ä¸­é–“æ°´æ§½æ¶²ä½",   unit: "cm",   cat: "level" },
                { col: "FI003_VAL0",   tag: "FIT05-04",  name: "DAFé€²å£æµé‡",    unit: "M3/Hr",cat: "flow" },
                { col: "PHI015_VAL0",  tag: "PH05-05",   name: "éœæ…‹æ”ªæ‹Œç®¡PH",   unit: "",     cat: "quality" }
                // ç§»é™¤äº† SLI004_VAL0 (æ²¹è†œæª¢çŸ¥)
            ]
        },
        {
            id: "cds", title: "CDS åŠ è—¥ç³»çµ±", className: "group-cds",
            items: [
                { col: "LI044_VAL0",   tag: "LI044",     name: "é¹¼æ§½æ¶²ä½",       unit: "cm",   cat: "level" },
                { col: "LI048_VAL0",   tag: "LI048",     name: "å‡è† å„²æ§½æ¶²ä½",   unit: "cm",   cat: "level" },
                { col: "LI049_VAL0",   tag: "LI049",     name: "PACå„²æ§½æ¶²ä½",    unit: "cm",   cat: "level" }
            ]
        }
    ];

    // --- æ·±æ·ºæ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
        document.getElementById("themeBtn").innerHTML = newTheme === "dark" ? "â˜€ï¸" : "ğŸŒ“";
        // å¦‚æœåœ–è¡¨å­˜åœ¨ï¼Œéœ€è¦æ›´æ–°åœ–è¡¨é¡è‰²
        if(myChart) updateChart(); 
    }

    // è¼‰å…¥æ™‚è®€å–è¨­å®š
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
        document.body.setAttribute("data-theme", savedTheme);
        document.getElementById("themeBtn").innerHTML = savedTheme === "dark" ? "â˜€ï¸" : "ğŸŒ“";
    }

    // --- æ•¸æ“šèˆ‡è­¦å ± ---
    function checkAlarm(colName, value) {
        let val = parseFloat(value);
        if (isNaN(val)) return "";
        
        if (colName.indexOf("PHI") !== -1) {
            if (val < 6 || val > 9) return "status-critical";
            if (val < 6.5 || val > 8.5) return "status-warning";
            return "";
        }
        const rule = ALARMS[colName];
        if (rule) {
            if (val >= rule.crit) return "status-critical";
            if (val >= rule.warn) return "status-warning";
        }
        return "";
    }

    function fetchData() {
        fetch(API_URL + "?mode=read&t=" + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if(data.timestamp) {
                    let timeOnly = data.timestamp.split(' ')[1] || data.timestamp;
                    document.getElementById('last-update').innerText = timeOnly;
                }

                let htmlContent = '';

                DASHBOARD_CONFIG.forEach(group => {
                    htmlContent += `
                        <div class="system-group ${group.className}">
                            <div class="system-title">${group.title} <span>${group.items.length}</span></div>
                            <div class="inner-grid">
                    `;

                    group.items.forEach(item => {
                        let val = data[item.col] !== undefined ? data[item.col] : '--';
                        if (!isNaN(val) && val.toString().indexOf('.') !== -1) {
                             val = parseFloat(val).toFixed(1);
                             if(val.endsWith('.0')) val = val.replace('.0', '');
                        }
                        let statusClass = checkAlarm(item.col, val);
                        htmlContent += `
                            <div class="card ${statusClass}">
                                <div class="card-header"><span class="tag-name">${item.name}</span><span class="tag-id">${item.tag}</span></div>
                                <div class="data-row"><span class="value">${val}</span><span class="unit">${item.unit}</span></div>
                            </div>`;
                    });
                    htmlContent += `</div></div>`;
                });
                document.getElementById('app').innerHTML = htmlContent;
            })
            .catch(err => console.error(err));
    }

    setInterval(fetchData, 5000);
    fetchData();

    // --- åœ–è¡¨é‚è¼¯ (æ”¯æ´æ·±è‰²æ¨¡å¼æ–‡å­—é¡è‰²) ---
    let historyData = null;
    let myChart = null;

    function openChartModal() {
        document.getElementById('chartModal').style.display = 'block';
        renderCheckboxes();
        if (!historyData) fetchHistory();
    }

    function closeChartModal() {
        document.getElementById('chartModal').style.display = 'none';
    }

    function fetchHistory() {
        fetch(API_URL + "?mode=history")
            .then(res => res.json())
            .then(json => {
                historyData = json;
                updateChart();
            });
    }

    function renderCheckboxes() {
        const cat = document.getElementById('categorySelect').value;
        const container = document.getElementById('tagCheckboxes');
        container.innerHTML = '';
        let items = [];
        DASHBOARD_CONFIG.forEach(group => {
            group.items.forEach(item => {
                if (item.cat === cat) items.push(item);
            });
        });
        items.forEach((item, index) => {
            const checked = index === 0 ? 'checked' : '';
            container.innerHTML += `
                <div class="checkbox-item">
                    <input type="checkbox" value="${item.col}" id="chk_${item.col}" ${checked} onchange="updateChart()">
                    <label for="chk_${item.col}">${item.name} (${item.tag})</label>
                </div>
            `;
        });
        updateChart();
    }

    function updateChart() {
        if (!historyData) return;
        const timeRangeHours = parseInt(document.getElementById('timeRange').value);
        const headers = historyData.headers;
        const rawRows = historyData.data;
        const checkboxes = document.querySelectorAll('#tagCheckboxes input:checked');
        const selectedCols = [];
        checkboxes.forEach(chk => {
            const idx = headers.indexOf(chk.value);
            if (idx !== -1) {
                selectedCols.push({ idx: idx, label: chk.nextElementSibling.innerText, data: [] });
            }
        });

        const now = new Date();
        const labels = [];
        rawRows.forEach(row => {
            let timeStr = row[0];
            let rowDate = new Date(timeStr);
            let diffHours = (now - rowDate) / 1000 / 60 / 60;
            if (diffHours <= timeRangeHours) {
                let label = rowDate.getMonth()+1 + "/" + rowDate.getDate() + " " + rowDate.getHours() + ":" + (rowDate.getMinutes()<10?'0':'') + rowDate.getMinutes();
                labels.push(label);
                selectedCols.forEach(col => { col.data.push(row[col.idx]); });
            }
        });

        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        const isDark = document.body.getAttribute("data-theme") === "dark";
        const gridColor = isDark ? '#444' : '#ddd';
        const textColor = isDark ? '#eee' : '#666';
        const colors = ['#007bff', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#17a2b8', '#e83e8c'];

        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: selectedCols.map((col, i) => ({
                    label: col.label,
                    data: col.data,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length],
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: false,
                    tension: 0.1
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    x: { ticks: { maxTicksLimit: 10, color: textColor }, grid: { color: gridColor } },
                    y: { beginAtZero: false, ticks: { color: textColor }, grid: { color: gridColor } }
                },
                plugins: {
                    legend: { labels: { color: textColor } }
                }
            }
        });
    }
</script>

</body>
</html>
